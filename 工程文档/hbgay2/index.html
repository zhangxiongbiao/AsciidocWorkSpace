<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="description" content="简述各工程的实现">
<meta name="author" content="张雄彪">
<title>工程实现文档</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: #fff; color: #222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

object, svg { display: inline-block; vertical-align: middle; }

.center { margin-left: auto; margin-right: auto; }

.spread { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #003b6b; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00579e; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #333; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: Arial, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Arial, sans-serif; font-weight: normal; font-style: normal; color: #7B2D00; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #ff6b15; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #ddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #003426; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: Arial, sans-serif; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #ddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #ddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #e15200; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #e15200; }

blockquote, blockquote p { line-height: 1.6; color: #333; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #ddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: #fff; margin-bottom: 1.25em; border: solid 1px #d8d8ce; }
table thead, table tfoot { background: -webkit-linear-gradient(top, #add386, #90b66a); font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #fff; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #6d6e71; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #edf2f2; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

body { tab-size: 4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eee; border: 1px solid #ddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

.keyseq { color: #333333; }

kbd { font-family: Consolas, "Liberation Mono", Courier, monospace; display: inline-block; color: black; font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -moz-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: #7B2D00; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #ddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #ddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #ddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #e15200; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #333; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #333; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: #7B2D00; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 0 solid #ddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: Arial, sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #003b6b; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #fff; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #ddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #ddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: #fff; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 0 solid #ddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #7B2D00; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #622400; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: #7B2D00; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #ddd; color: #e15200; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: #fff; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: #fff; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #003b6b; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px dashed #666; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 1.25em 1.5625em 1.125em 1.5625em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 1.25em 1.5625em 1.125em 1.5625em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; line-height: 1.6; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #ddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 0.75em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #333; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #003b6b; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #e15200; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 0.75em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #333; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: #e15200; }

.quoteblock.abstract { margin: 0 0 0.75em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #d8d8ce; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: -webkit-linear-gradient(top, #add386, #90b66a); }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #fff; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1em; font-size: 0.85em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { width: 1em; position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.375em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }

td.hdlist1 { font-weight: bold; padding-bottom: 0.75em; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px #fff; -webkit-box-shadow: 0 0 0 1px #ddd; box-shadow: 0 0 0 1px #ddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }

sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.05em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #004177; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { border-bottom: 1px solid #ddd; }

.sect1 { padding-bottom: 0; }

#toctitle { color: #00406F; font-weight: normal; margin-top: 1.5em; }

.sidebarblock { border-color: #aaa; }

code { -webkit-border-radius: 4px; border-radius: 4px; }

p.tableblock.header { color: #6d6e71; }

.literalblock pre, .listingblock pre { background: #eee; }

</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>工程实现文档</h1>
<div class="details">
<span id="author" class="author">张雄彪</span><br>
<span id="email" class="email"><a href="mailto:zxb@dameng.com">zxb@dameng.com</a></span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2016-03-19</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#sso-单点登录">sso 单点登录</a>
<ul class="sectlevel1">
<li><a href="#实现机制">1. 实现机制</a></li>
<li><a href="#主要实现技术">2. 主要实现技术</a></li>
<li><a href="#现有实现设计">3. 现有实现设计</a></li>
</ul>
</li>
<li><a href="#dmcas">dmcas</a>
<ul class="sectlevel1">
<li><a href="#名词说明">4. 名词说明</a></li>
<li><a href="#实现技术">5. 实现技术</a></li>
<li><a href="#实现细节">6. 实现细节</a>
<ul class="sectlevel2">
<li><a href="#包图">6.1. 包图</a></li>
<li><a href="#功能模块说明">6.2. 功能模块说明</a>
<ul class="sectlevel3">
<li><a href="#登入">6.2.1. 登入</a></li>
<li><a href="#登出">6.2.2. 登出</a></li>
<li><a href="#票据验证">6.2.3. 票据验证</a></li>
<li><a href="#子系统及跨系统访问">6.2.4. 子系统及跨系统访问</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#dmcas-client">dmcas-client</a>
<ul class="sectlevel1">
<li><a href="#部署使用说明">7. 部署使用说明</a>
<ul class="sectlevel2">
<li><a href="#获取程序包">7.1. 获取程序包</a></li>
<li><a href="#编写配置文件">7.2. 编写配置文件</a></li>
<li><a href="#配置过滤器">7.3. 配置过滤器</a></li>
<li><a href="#添加域至信任列表">7.4. 添加域至信任列表</a></li>
</ul>
</li>
<li><a href="#实现讲解说明">8. 实现讲解说明</a>
<ul class="sectlevel2">
<li><a href="#authfilter核心过滤器">8.1. AuthFilter核心过滤器</a></li>
<li><a href="#casconf配置">8.2. CASConf配置</a></li>
<li><a href="#casutil-工具">8.3. CASUtil 工具</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dmcas-validation">dmcas-validation</a>
<ul class="sectlevel1">
<li><a href="#接口">9. 接口</a></li>
<li><a href="#默认实现">10. 默认实现</a>
<ul class="sectlevel2">
<li><a href="#authservice">10.1. AuthService</a></li>
<li><a href="#loginpostprocessservice">10.2. LoginPostProcessService</a></li>
<li><a href="#loginfailprocessservice">10.3. LoginFailProcessService</a></li>
<li><a href="#usermapperservice">10.4. UserMapperService</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dmga-portal-hb">dmga-portal-hb</a>
<ul class="sectlevel1">
<li><a href="#pki登录">11. pki登录</a>
<ul class="sectlevel2">
<li><a href="#引入类库">11.1. 引入类库</a></li>
<li><a href="#pki-jsp编写">11.2. pki.jsp编写</a></li>
<li><a href="#配置过滤器-2">11.3. 配置过滤器</a></li>
<li><a href="#登录请求">11.4. 登录请求</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dmga-dubbo-wsdl">dmga-dubbo-wsdl</a>
<ul class="sectlevel1">
<li><a href="#简述">12. 简述</a>
<ul class="sectlevel2">
<li><a href="#概要说明">12.1. 概要说明</a></li>
<li><a href="#实现框架">12.2. 实现框架</a></li>
<li><a href="#实现概览">12.3. 实现概览</a></li>
</ul>
</li>
<li><a href="#代码说明">13. 代码说明</a>
<ul class="sectlevel2">
<li><a href="#包图及描述">13.1. 包图及描述</a></li>
</ul>
</li>
<li><a href="#各功能模块说明">14. 各功能模块说明</a>
<ul class="sectlevel2">
<li><a href="#em-ws-em-服务的注册">14.1. <em>ws</em> 服务的注册</a>
<ul class="sectlevel3">
<li><a href="#类图">14.1.1. 类图</a></li>
<li><a href="#加载ws配置信息">14.1.2. 加载ws配置信息</a></li>
<li><a href="#动态生成接口">14.1.3. 动态生成接口</a></li>
<li><a href="#动态生成实现类">14.1.4. 动态生成实现类</a></li>
<li><a href="#服务缓存">14.1.5. 服务缓存</a></li>
<li><a href="#服务配置">14.1.6. 服务配置</a></li>
</ul>
</li>
<li><a href="#em-ws-em-服务的调用">14.2. <em>ws</em> 服务的调用</a>
<ul class="sectlevel3">
<li><a href="#类图-2">14.2.1. 类图</a></li>
<li><a href="#strong-em-cxf-em-strong-调用">14.2.2. <strong><em>CXF</em></strong> 调用</a></li>
<li><a href="#strong-em-axis1-4-em-strong-调用">14.2.3. <strong><em>axis1.4</em></strong> 调用</a></li>
</ul>
</li>
<li><a href="#em-ws-em-服务拦截">14.3. <em>ws</em> 服务拦截</a>
<ul class="sectlevel3">
<li><a href="#类图-3">14.3.1. 类图</a></li>
<li><a href="#实现思路">14.3.2. 实现思路</a></li>
<li><a href="#实现细节-3">14.3.3. 实现细节</a></li>
</ul>
</li>
<li><a href="#em-wsdl-em-文档解析">14.4. <em>wsdl</em> 文档解析</a>
<ul class="sectlevel3">
<li><a href="#类图-4">14.4.1. 类图</a></li>
<li><a href="#实现框架-2">14.4.2. 实现框架</a></li>
<li><a href="#em-cxf-em-的-em-wsdl-em-解析">14.4.3. <em>CXF</em> 的 <em>wsdl</em> 解析</a></li>
<li><a href="#em-axis1-4-em-的-em-wsdl-em-解析">14.4.4. <em>axis1.4</em> 的 <em>wsdl</em> 解析</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#启动与打包">15. 启动与打包</a>
<ul class="sectlevel2">
<li><a href="#启动方式">15.1. 启动方式</a>
<ul class="sectlevel3">
<li><a href="#编写main方法启动">15.1.1. 编写main方法启动</a></li>
<li><a href="#以-em-dubbo-em-提供的-em-main-em-类启动">15.1.2. 以 <em>dubbo</em> 提供的 <em>Main</em> 类启动</a></li>
</ul>
</li>
<li><a href="#打包">15.2. 打包</a></li>
<li><a href="#启动脚本">15.3. 启动脚本</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="sso-单点登录" class="sect0"><a class="anchor" href="#sso-单点登录"></a>sso 单点登录</h1>
<div class="openblock partintro">
<div class="content">
SSO英文全称Single Sign On，单点登录。SSO是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。它包括可以将这次主要的登录映射到其他应用中用于同一个用户的登录的机制。它是目前比较流行的企业业务整合的解决方案之一。
</div>
</div>
<div class="sect1">
<h2 id="实现机制"><a class="anchor" href="#实现机制"></a>1. 实现机制</h2>
<div class="sectionbody">
<div class="paragraph">
<p>当用户第一次访问应用系统1的时候，因为还没有登录，会被引导到认证系统中进行登录；根据用户提供的登录信息，认证系统进行身份校验，如果通过校验，应该返回给用户一个认证的凭据－－ticket；用户再访问别的应用的时候就会将这个ticket带上，作为自己认证的凭据，应用系统接受到请求之后会把ticket送到认证系统进行校验，检查ticket的合法性。如果通过校验，用户就可以在不用再次登录的情况下访问应用系统2和应用系统3了。
要实现SSO，需要以下主要的功能：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">系统共享</dt>
<dd>
<p>统一的认证系统是SSO的前提之一。认证系统的主要功能是将用户的登录信息和用户信息库相比较，对用户进行登录认证；认证成功后，认证系统应该生成统一的认证标志（ticket），返还给用户。另外，认证系统还应该对ticket进行校验，判断其有效性。</p>
</dd>
<dt class="hdlist1">信息识别</dt>
<dd>
<p>要实现SSO的功能，让用户只登录一次，就必须让应用系统能够识别已经登录过的用户。应用系统应该能对ticket进行识别和提取，通过与认证系统的通讯，能自动判断当前用户是否登录过，从而完成单点登录的功能。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="主要实现技术"><a class="anchor" href="#主要实现技术"></a>2. 主要实现技术</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">基于cookies实现</dt>
<dd>
<p>如果是基于两个域名之间传递sessionid的方法可能在windows中成立，在unix&amp;linux中可能会出现问题;可以基于数据库实现；在安全性方面可能会作更多的考虑。另外，关于跨域问题，虽然cookies本身不跨域，但可以利用它实现跨域的SSO。</p>
</dd>
<dt class="hdlist1">Broker-based（基于经纪人）</dt>
<dd>
<p>这种技术的特点就是，有一个集中的认证和用户帐号管理的服务器。经纪人给被用于进一步请求的电子的身份存取。</p>
</dd>
<dt class="hdlist1">Agent-based（基于代理人）</dt>
<dd>
<p>在这种解决方案中，有一个自动地为不同的应用程序认证用户身份的代理程序。这个代理程序需要设计有不同的功能。比如，它可以使用口令表或加密密钥来自动地将认证的负担从用户移开。代理人被放在服务器上面，在服务器的认证系统和客户端认证方法之间充当一个"翻译"。例如SSH等。</p>
</dd>
<dt class="hdlist1">Token-based</dt>
<dd>
<p>例如SecurID,WebID，现在被广泛使用的口令认证，比如FTP,邮件服务器的登录认证，这是一种简单易用的方式，实现一个口令在多种应用当中使用。</p>
</dd>
<dt class="hdlist1">基于安全断言标记语言（SAML）实现</dt>
<dd>
<p>SAML(Security Assertion Markup Language，安全断言标记语言）的出现大大简化了SSO，并被OASIS批准为SSO的执行标准。开源组织OpenSAML 实现了 SAML 规范。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="现有实现设计"><a class="anchor" href="#现有实现设计"></a>3. 现有实现设计</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">实现方式</dt>
<dd>
<p>目前在现在的系统中，采用了基于 <em>cookies</em> 的实现，在多个系统中使用 <em>cookie</em> 来传输票据。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>单点登录实现的要点在于将认证中心进行统一，在所有系统之上构建一个唯一的认证中心即可。如下图，多系统之间的访问，票据认证应该全部在统一认证中心完成。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/sso.png" alt="sso">
</div>
<div class="title">访问示意图</div>
</div>
<div class="paragraph">
<p>然而在面临多系统之间，不同的用户体系<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>时，如果还继续将用户的校验放在 <em>dmcas</em> 统一认证中心完成，那么将无法完成多系统不同用户之间的集成。</p>
</div>
<div class="paragraph">
<p>此时的结构应该如下图，各子系统独立完成自己的用户检验，角色权限控制。 <strong><em>dmcas</em> 只应该存储票据与信任列表，进行票据校验即可</strong>。此时 <em>dmcas</em> 在中间还应 <strong>协调</strong> 完成各子系统的 <strong>用户匹配</strong>，具体如何 <strong>匹配</strong> 还是由子系统决定， <em>dmcas</em> 在中间充当一个 <strong>调度者</strong> 的角色。</p>
</div>
<div class="paragraph">
<p>这种结构就决定了 <em>dmcas</em> 与子系统之间只需要依赖公共接口，通过 <em>rpc</em> 调用完成。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/sso-cross.png" alt="sso cross">
</div>
<div class="title">多系统之间认证</div>
</div>
</div>
</div>
<h1 id="dmcas" class="sect0"><a class="anchor" href="#dmcas"></a>dmcas</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p><em>dmcas</em> 作为 <em>sso</em> 中的协调者，主要的职责是：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>票据的生成与校验</p>
</li>
<li>
<p>各子系统之间协调访问</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="名词说明"><a class="anchor" href="#名词说明"></a>4. 名词说明</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">票据中心</dt>
<dd>
<p>这里指后台专门存放用户 <em>ticket</em> 信息的 <em>cache</em> ，目前采用的是 <em>memcached</em> 进行存储。</p>
</dd>
<dt class="hdlist1">信任列表</dt>
<dd>
<p>这里指各接入的子系统的域名列表。只有加入到了信任列表中的子系统，才可与其它子系统互相访问。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="实现技术"><a class="anchor" href="#实现技术"></a>5. 实现技术</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">spring</dt>
<dd>
<p>采用 <em>spring</em> 容器管理 <em>service bean</em></p>
</dd>
<dt class="hdlist1">mybatis</dt>
<dd>
<p>采用 <em>mybatis</em> 完成 <em>database</em> 的访问</p>
</dd>
<dt class="hdlist1">springmvc</dt>
<dd>
<p>采用 <em>springmvc</em> 完成页面控制层的请求处理</p>
</dd>
<dt class="hdlist1">memcached</dt>
<dd>
<p>采用 <em>memcached</em> 进行后台票据的存储管理</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="实现细节"><a class="anchor" href="#实现细节"></a>6. 实现细节</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="包图"><a class="anchor" href="#包图"></a>6.1. 包图</h3>
<div class="imageblock">
<div class="content">
<img src="./images/package.svg" alt="package">
</div>
</div>
<div class="olist arabic">
<div class="title">包说明</div>
<ol class="arabic">
<li>
<p>core: 存放一些框架包</p>
<div class="ulist">
<ul>
<li>
<p>builder: 存放 <em>memcached client</em> 构造内容</p>
</li>
<li>
<p>dao: 存放 <em>dao</em> 层</p>
</li>
<li>
<p>filter: 存放框架上的一些 <em>web filter</em></p>
</li>
<li>
<p>util: 存放工具类</p>
</li>
</ul>
</div>
</li>
<li>
<p>server: 存放 <em>dmcas</em> 对外服务内容</p>
<div class="ulist">
<ul>
<li>
<p>cache: 一些缓存类</p>
</li>
<li>
<p>controller: 存放 <em>controller</em> 类等</p>
</li>
<li>
<p>service: 接口服务类</p>
</li>
<li>
<p>domain: 存放实体类</p>
</li>
<li>
<p>handler: 存放一些处理器</p>
</li>
<li>
<p>thread: 自定义线程类</p>
</li>
<li>
<p>filter: 存放服务上的 <em>web filter</em></p>
</li>
<li>
<p>http: 存放 <em>request</em> 包装类等</p>
</li>
<li>
<p>util: 存放 <em>web</em> 相关工具类</p>
</li>
<li>
<p>config: 存放服务的一些配置信息</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="功能模块说明"><a class="anchor" href="#功能模块说明"></a>6.2. 功能模块说明</h3>
<div class="sect3">
<h4 id="登入"><a class="anchor" href="#登入"></a>6.2.1. 登入</h4>
<div class="paragraph">
<p>用户请求登录的逻辑主要在 <em>AuthController</em> ，此处主要提供的都是异步请求调用的方法（包括 <em>jsonp</em> ）</p>
</div>
<div class="listingblock">
<div class="title">code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 用户账号登录
 *
 * @param request  请求
 * @param response 响应
 * @return
 * @throws Exception
 */</span>
<span class="annotation">@SuppressWarnings</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>})
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/login</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> ModelAndView login(HttpServletRequest request, HttpServletResponse response) <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="keyword">return</span> doLogin(request, response, <span class="keyword">new</span> LoginSucessHandler() {
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> handle(HttpServletRequest request, HttpServletResponse response, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span> {
            response.sendRedirect(params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">service</span><span class="delimiter">&quot;</span></span>).toString());
        }
    }, <span class="keyword">new</span> LoginFailHandler() {
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> handle(HttpServletRequest request, HttpServletResponse response, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span> {
            AuthResult authResult = (AuthResult) params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">authResult</span><span class="delimiter">&quot;</span></span>);
            Domain domain = (Domain) params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">domain</span><span class="delimiter">&quot;</span></span>);
            send2Login(request, response, authResult.getMessage(), domain);
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>由上面看出，登录的主要逻辑在于 <em>doLogin</em> 方法，此处只是 <em>doLogin</em> 方法使用 <strong>策略模式</strong> ，要求调用者传入了两个接口实现。</p>
</div>
<div class="paragraph">
<p>而在 <em>doLogin</em> 中，请求逻辑也相对简单，分为以下几步。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>获取请求参数并校验</p>
</li>
<li>
<p><em>rpc</em> 调用子系统实现，完成 <strong>用户名、密码</strong> 的校验</p>
</li>
<li>
<p>调用 <strong>登录成功/失败</strong> 的子系统处理逻辑</p>
</li>
<li>
<p>生成票据信息，存入 <strong>票据中心</strong></p>
</li>
<li>
<p>返回登录结果及票据</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">code</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">authResult = <span class="local-variable">this</span>.getAuthResult(request, domain); <img src="./images/icons/callouts/1.png" alt="1">

<span class="keyword">if</span> (authResult.isValid()) {
  <span class="comment">// rpc调用子系统登录成功后处理实现</span>
 ReturnMessage returnMessage = invokeLoginPostProcess(domain, request, authResult, username, password); <img src="./images/icons/callouts/2.png" alt="2">

 authid = AuthCache.set(username, ip, domain.getDomainName(), idCardNo); <img src="./images/icons/callouts/3.png" alt="3">
 <span class="comment">// 调用方自定义登录成功后处理逻辑</span>
 sucessHandler.handle(request, response, params); <img src="./images/icons/callouts/4.png" alt="4">
}<span class="keyword">else</span>{
  <span class="comment">// rpc调用子系统登录失败后处理实现</span>
  ReturnMessage returnMessage = invokeLoginFailProcess(domain, request, authResult,  username, password); <img src="./images/icons/callouts/5.png" alt="5">
  params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">returnMessage</span><span class="delimiter">&quot;</span></span>, returnMessage);
  <span class="comment">// 调用方自定义登录失败后处理逻辑</span>
  failHandler.handle(request, response, params); <img src="./images/icons/callouts/6.png" alt="6">
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td><em>rpc</em> 调用子系统完成用户名/密码的校验</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td><em>prc</em> 调用子系统登录成功后的处理逻辑</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>存储票据至票据中心</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>调用自定义登录成功处理逻辑（策略模式）</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/5.png" alt="5"></td>
<td><em>rpc</em> 调用子系统登录失败后处理实现</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/6.png" alt="6"></td>
<td>调用自定义登录失败后处理逻辑（策略模式）</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="登出"><a class="anchor" href="#登出"></a>6.2.2. 登出</h4>
<div class="paragraph">
<p>登出则非常简单，分两个步骤。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>注销用户票据</p>
</li>
<li>
<p>重定向至登出页面</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="票据验证"><a class="anchor" href="#票据验证"></a>6.2.3. 票据验证</h4>
<div class="paragraph">
<p>子系统的访问请求被 <em>cas-client</em> 拦截后，会通过模拟 <em>http</em> 请求完成校验。具体见 <em>cas-client</em> 中的 <em>AuthFilter</em> 的 <em>getAuthUser</em> 方法。</p>
</div>
<div class="paragraph">
<p>在 <em>dmcas</em> 中则提供了该 <em>http</em> 请求的服务方法。</p>
</div>
<div class="listingblock">
<div class="title">AuthInfoController</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 根据authid获取认证的用户信息
 *
 * @param request
 * @param response
 * @return
 * @throws Exception
 */</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/getAuthUser</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> ModelAndView getAuthUser(HttpServletRequest request,HttpServletResponse response) <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="comment">// 用户原来的访问地址</span>
    <span class="predefined-type">String</span> authid = request.getParameter(CASConf.getCasTicketName());
    <span class="predefined-type">String</span> ip = RequestUtil.getRemoteAddr(request);
    <span class="predefined-type">String</span> username = AuthCache.get(authid, ip); <img src="./images/icons/callouts/1.png" alt="1">
    <span class="keyword">if</span> (StringUtils.hasText(username)) {
        response.getWriter().write(username);
    }
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>直接从票据中心获取票据信息</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>cas-client</em> 中通过此途径获取票据信息后，则只需要判断是否存在信息即可确定票据是否存在。</p>
</div>
</div>
<div class="sect3">
<h4 id="子系统及跨系统访问"><a class="anchor" href="#子系统及跨系统访问"></a>6.2.4. 子系统及跨系统访问</h4>
<div class="paragraph">
<p>众所周知，基于 <em>cookie</em> 挟带票据的 <em>sso</em> 中会受限于 <em>cookie</em> 无法跨域访问。此时需要一个公共的 <strong>父域</strong> ，而各子系统的域名则作为 <strong>子域</strong> 存在。但是在目前的环境下，通常不能方便地申请到这样的域名。此时需要寻找其它的方法来解决这个问题。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">解决思路</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在登录的同时，对各子域设计跨域 <em>cookie</em> ，然后再访问各子系统时自然就能带 <em>cookie</em> 访问。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">优点</dt>
<dd>
<p>实现简单且有效</p>
</dd>
<dt class="hdlist1">缺点</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>登录时较慢（由于在设置跨域 <em>cookie</em> ）</p>
</li>
<li>
<p>如果子系统设置 <em>cookie</em> 失败（如子系统正好宕机了），稍候访问子系统将会要求重新登录。</p>
</li>
<li>
<p>不易与其它非子系统的第三方系统（有独立用户体系）集成。</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>独立 <em>dmcas</em> 验证中心，各系统验证信息独自完成。 <em>dmcas</em> 作好协调者。此时基于用户来访 <em>ip</em> 来确定是同一用户的访问。</p>
<div class="dlist">
<dl>
<dt class="hdlist1">优点</dt>
<dd>
<p>方便集成其它系统，很容易拓展。</p>
</dd>
<dt class="hdlist1">缺点</dt>
<dd>
<p>ip可被伪装，且已登录时关闭浏览器后再打开会自动登录。</p>
</dd>
</dl>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">
<div class="paragraph">
<p>现有的系统中 <em>dmcas</em> 采用的是第一种解决方案。</p>
</div>
<div class="paragraph">
<p>目前正在做的是升级为第二种解决方案。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="实现细节-2"><a class="anchor" href="#实现细节-2"></a>实现细节</h5>
<div class="imageblock">
<div class="content">
<img src="./images/dmcas_request.png" alt="dmcas request">
</div>
</div>
<div class="paragraph">
<p>整个验证流程如上图所示。</p>
</div>
</div>
<div class="sect4">
<h5 id="实现代码"><a class="anchor" href="#实现代码"></a>实现代码</h5>
<div class="paragraph">
<p>代码如下：
见 <code>AuthInfoController</code> 中的 <code>getAuthInfo</code></p>
</div>
<div class="listingblock">
<div class="title">AuthInfoController.getAuthInfo</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> clientIp = request.getParameter(CASConf.getIpName()); <img src="./images/icons/callouts/1.png" alt="1">

<span class="comment">// 获取ip对应的用户信息</span>
 <span class="predefined-type">String</span> authInfo = AuthCache.getByClientIp(clientIp);
 <span class="keyword">if</span> (!StringUtils.hasText(authInfo)) {
     logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">[clientIP:</span><span class="delimiter">&quot;</span></span> + clientIp + <span class="string"><span class="delimiter">&quot;</span><span class="content">] no auth info found by clientIp </span><span class="delimiter">&quot;</span></span> + clientIp);
     <span class="keyword">return</span> <span class="predefined-constant">null</span>; <img src="./images/icons/callouts/2.png" alt="2">
 }

<span class="predefined-type">String</span> host = request.getRemoteHost();
logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">[clientIP:</span><span class="delimiter">&quot;</span></span> + clientIp + <span class="string"><span class="delimiter">&quot;</span><span class="content">] getAuthInfo,the user request domain：</span><span class="delimiter">&quot;</span></span> + host);

Domain requestDomain = DomainCache.get(host); <img src="./images/icons/callouts/3.png" alt="3">

<span class="predefined-type">String</span><span class="type">[]</span> authArr = authInfo.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">&amp;</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">String</span> userCode = authArr[<span class="integer">1</span>];
<span class="predefined-type">String</span> loginHost = authArr[<span class="integer">2</span>];
Domain loginDomain = DomainCache.get(loginHost); <img src="./images/icons/callouts/4.png" alt="4">

<span class="comment">// 获取该用户在登录时的域对应的系统中的用户信息</span>
logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">[clientIP:</span><span class="delimiter">&quot;</span></span> + clientIp + <span class="string"><span class="delimiter">&quot;</span><span class="content">, userCode:</span><span class="delimiter">&quot;</span></span> + userCode + <span class="string"><span class="delimiter">&quot;</span><span class="content">] begin get login domain(</span><span class="delimiter">&quot;</span></span> + loginDomain.getDomainName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">)'s user info!</span><span class="delimiter">&quot;</span></span>);
UserMapperService userMapperService = ConsumerCache.get(loginDomain, UserMapperService.class);
<span class="keyword">if</span> (userMapperService == <span class="predefined-constant">null</span>) {
logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">can't find login domain's consumer from registry center! domain name:</span><span class="delimiter">&quot;</span></span> + loginDomain.getDomainName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">, group:</span><span class="delimiter">&quot;</span></span> + loginDomain.getGroupName());
<span class="keyword">return</span> <span class="predefined-constant">null</span>;
}  <img src="./images/icons/callouts/5.png" alt="5">

<span class="comment">// 根据该用户信息获取其在被请求的域对应的系统中的用户信息</span>
 logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">[clientIP:</span><span class="delimiter">&quot;</span></span> + clientIp + <span class="string"><span class="delimiter">&quot;</span><span class="content">, userCode:</span><span class="delimiter">&quot;</span></span> + userCode + <span class="string"><span class="delimiter">&quot;</span><span class="content">] begin get </span><span class="delimiter">&quot;</span></span> + user.getUser_code() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> mappingUser from requestDomain </span><span class="delimiter">&quot;</span></span> + requestDomain.getDomainName());
 userMapperService = ConsumerCache.get(requestDomain, UserMapperService.class);
 <span class="keyword">if</span> (userMapperService == <span class="predefined-constant">null</span>) {
     logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">can't find request domain's consumer from registry center! domain name:</span><span class="delimiter">&quot;</span></span> + requestDomain.getDomainName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">, group:</span><span class="delimiter">&quot;</span></span> + requestDomain.getGroupName());
     <span class="keyword">return</span> <span class="predefined-constant">null</span>;
 }

 User mapperUser = userMapperService.getUser(user);

 <span class="comment">// 未返回映射用户</span>
 <span class="keyword">if</span> (mapperUser == <span class="predefined-constant">null</span> || !StringUtils.hasText(mapperUser.getUser_code())) {
     logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">[clientIP:</span><span class="delimiter">&quot;</span></span> + clientIp + <span class="string"><span class="delimiter">&quot;</span><span class="content">, userCode:</span><span class="delimiter">&quot;</span></span> + userCode + <span class="string"><span class="delimiter">&quot;</span><span class="content">] current login user:</span><span class="delimiter">&quot;</span></span> + user.getUser_code() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> can't visit from login domain </span><span class="delimiter">&quot;</span></span> + loginDomain.getDomainName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> to request domain:</span><span class="delimiter">&quot;</span></span> + requestDomain.getDomainName());
     <span class="keyword">return</span> <span class="predefined-constant">null</span>;
 }  <img src="./images/icons/callouts/6.png" alt="6">

 response.getWriter().write(sb.toString()); <img src="./images/icons/callouts/7.png" alt="7"></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>获取 <em>client</em> 拦截时获取到的用户访问 <a href="#ip">ip</a> ，这里可能会有问题，如果对方通过 <em>nginx</em> 代理的请求，且未提供一个 <em>header</em> 保存用户的 <em>ip</em> 。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>校验用户 <em>authInfo</em> 信息是否存在</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>获取用户正要请求的域</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>从 <em>authinfo</em> 中获取用户登陆时存储的域地址</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/5.png" alt="5"></td>
<td>获取用户登录时的用户信息。 <em>rpc</em> 调用</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/6.png" alt="6"></td>
<td>获取用户在目前被访问的系统中的映射后的用户信息。 <em>rpc</em> 调用</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/7.png" alt="7"></td>
<td>将获取到的映射用户信息回写</td>
</tr>
</table>
</div>
<div id="ip" class="listingblock">
<div class="title">get user ip address</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">String</span> getClientIpAddr(HttpServletRequest request) {

  <span class="predefined-type">String</span> ip = request.getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">x-forwarded-for</span><span class="delimiter">&quot;</span></span>);

  <span class="keyword">if</span> (ip == <span class="predefined-constant">null</span> || ip.length() == <span class="integer">0</span> || <span class="string"><span class="delimiter">&quot;</span><span class="content">unknown</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(ip)) {

    ip = request.getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Proxy-Client-IP</span><span class="delimiter">&quot;</span></span>);

  }

  <span class="keyword">if</span> (ip == <span class="predefined-constant">null</span> || ip.length() == <span class="integer">0</span> || <span class="string"><span class="delimiter">&quot;</span><span class="content">unknown</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(ip)) {

    ip = request.getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">WL-Proxy-Client-IP</span><span class="delimiter">&quot;</span></span>);

  }

  <span class="keyword">if</span> (ip == <span class="predefined-constant">null</span> || ip.length() == <span class="integer">0</span> || <span class="string"><span class="delimiter">&quot;</span><span class="content">unknown</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(ip)) {

    ip = request.getRemoteAddr();

  }

  <span class="keyword">return</span> ip;

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="dmcas-client" class="sect0"><a class="anchor" href="#dmcas-client"></a>dmcas-client</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p><em>dmcas-client</em> 作为 <em>sso</em> 校验中的客户端，用来拦截各子系统发送的请求，在请求抵达子系统前完成访问 <em>dmcas</em> 完成用户信息校验工作。</p>
</div>
<div class="paragraph">
<p>正因为如此， <em>dmcas-client</em> 必须部署在各子系统中，通常也是以一个 <em>jar</em> <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup> 包的方式存在。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="部署使用说明"><a class="anchor" href="#部署使用说明"></a>7. 部署使用说明</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="获取程序包"><a class="anchor" href="#获取程序包"></a>7.1. 获取程序包</h3>
<div class="paragraph">
<p>第三方需要联系 <strong>湖北公安云</strong> 项目组获取 <em>dmcas-client</em> 的程序 <em>jar</em> 包。</p>
</div>
</div>
<div class="sect2">
<h3 id="编写配置文件"><a class="anchor" href="#编写配置文件"></a>7.2. 编写配置文件</h3>
<div class="paragraph">
<p>如新建 <em>cas-client.properties</em> 文件。编写如下内容：</p>
</div>
<div class="listingblock">
<div class="title">cas-client.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">casURL=http:<span class="comment">//localhost:8080/dmcas </span><img src="./images/icons/callouts/1.png" alt="1">
loginURL=http:<span class="comment">//localhost:8080/portal/login.do </span><img src="./images/icons/callouts/2.png" alt="2">
exceptPathPrefix=/ui/;/services/ <img src="./images/icons/callouts/3.png" alt="3">
publicPathPrefix=/common/;/portal/;/wmf/casAuth <img src="./images/icons/callouts/4.png" alt="4"></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>指定 <em>dmcas</em> 验证中心的访问地址，请填写实际地址。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>指定用户未登录后需要跳转到的地址，即配置登陆地址。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>希望加入例外的 <em>url</em> 匹配规则。 <strong>注意，不会获取用户信息，检测为例外请求后，会直接放行。</strong></td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>配置为公共请求 <em>url</em> 的匹配规则。 <strong>注意，会尝试获取用信息，不论是否获取得到，只要是公共请求，都会放行。</strong></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="配置过滤器"><a class="anchor" href="#配置过滤器"></a>7.3. 配置过滤器</h3>
<div class="paragraph">
<p>在子系统的 <em>web.xml</em> 文件中添加如下过滤器，请注意 <em>filter</em> 的顺序。具体该 <em>filter</em> 放在哪个位置视各系统而定。</p>
</div>
<div class="listingblock">
<div class="title">web.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- 单点登录客户端 --&gt;</span>
<span class="tag">&lt;filter&gt;</span>
  <span class="tag">&lt;filter-name&gt;</span>CASAuthFilter<span class="tag">&lt;/filter-name&gt;</span>
  <span class="tag">&lt;filter-class&gt;</span>com.dm.cas.client.filter.AuthFilter<span class="tag">&lt;/filter-class&gt;</span>
  <span class="tag">&lt;init-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>configMethod<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>file<span class="tag">&lt;/param-value&gt;</span> <img src="./images/icons/callouts/1.png" alt="1">
  <span class="tag">&lt;/init-param&gt;</span>
  <span class="tag">&lt;init-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>configFilePath<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>/WEB-INF/config/cas-client.properties<span class="tag">&lt;/param-value&gt;</span> <img src="./images/icons/callouts/2.png" alt="2">
  <span class="tag">&lt;/init-param&gt;</span>
<span class="tag">&lt;/filter&gt;</span>
<span class="tag">&lt;filter-mapping&gt;</span>
  <span class="tag">&lt;filter-name&gt;</span>CASAuthFilter<span class="tag">&lt;/filter-name&gt;</span>
  <span class="tag">&lt;url-pattern&gt;</span>*.do<span class="tag">&lt;/url-pattern&gt;</span> <img src="./images/icons/callouts/3.png" alt="3">
<span class="tag">&lt;/filter-mapping&gt;</span>
<span class="tag">&lt;filter-mapping&gt;</span>
  <span class="tag">&lt;filter-name&gt;</span>CASAuthFilter<span class="tag">&lt;/filter-name&gt;</span>
  <span class="tag">&lt;url-pattern&gt;</span>*.html<span class="tag">&lt;/url-pattern&gt;</span> <img src="./images/icons/callouts/4.png" alt="4">
<span class="tag">&lt;/filter-mapping&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>指定为 <em>file</em> 表示从配置文件中读取配置信息。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>指定配置文件的路径，此处应该配 <em>web</em> 工程的相对路径。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>指定请求拦截的 <em>url</em> 规则，例如此处为 *.do</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>指定请求拦截的 <em>url</em> 规则，例如此处为 *.html</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="添加域至信任列表"><a class="anchor" href="#添加域至信任列表"></a>7.4. 添加域至信任列表</h3>
<div class="paragraph">
<p>本来完成上述几步后，应该整个过程就结束了。这里最后一步是 <em>dmcas</em> 升级方案中需要做的。只有子系统的域在信任列表中时，才允许通过 <em>dmcas</em> 进行单点登陆。</p>
</div>
<div class="paragraph">
<p>所以最后需要联系 <strong>湖北公安云项目组</strong> 将子系统的域添加至信任列表中即可。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="实现讲解说明"><a class="anchor" href="#实现讲解说明"></a>8. 实现讲解说明</h2>
<div class="sectionbody">
<div class="paragraph">
<p>整个 <em>dmcas-client</em> 其实内容并不多，只有一个核心的过滤器和几个辅助工具类。</p>
</div>
<div class="paragraph">
<p>其实 <em>dmcas-client</em> 本身并不需要完成多少功能，它只需要拦截用户请求，请求 <em>dmcas</em> 完成用户信息校验，转发或重定向用户请求即可。</p>
</div>
<div class="sect2">
<h3 id="authfilter核心过滤器"><a class="anchor" href="#authfilter核心过滤器"></a>8.1. AuthFilter核心过滤器</h3>
<div class="paragraph">
<p><em>AuthFilter</em> 是 <em>javax.servlet.Filter</em> 的一个实现类。所以也就实现了该接口的三个方法。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>init</p>
</li>
<li>
<p>doFilter</p>
</li>
<li>
<p>destory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在 <em>init</em> 方法中，主要就是完成配置参数的加载工作了。此处是分为 <strong>从文件加载</strong> 和 <strong>从数据库加载</strong> 两种方式了。</p>
</div>
<div class="listingblock">
<div class="title">init</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> init(FilterConfig filterConfig) <span class="directive">throws</span> ServletException {
<span class="comment">// 获取配置方式</span>
<span class="predefined-type">String</span> configMethod = filterConfig.getInitParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">configMethod</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// 获取配置文件路径</span>
<span class="predefined-type">String</span> configFilePath = filterConfig.getInitParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">configFilePath</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// 使用配置文件cas-client.properties</span>
<span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">file</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(configMethod)) {
    <span class="keyword">try</span> {
        <span class="predefined-type">String</span> filePath = filterConfig.getServletContext().getRealPath(configFilePath);
        CASConf.init(filePath); <img src="./images/icons/callouts/1.png" alt="1">
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">init AuthFilter from file error!</span><span class="delimiter">&quot;</span></span>, e);
    }
    <span class="keyword">return</span>;
}
<span class="comment">// 使用数据库参数表</span>
<span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">db</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(configMethod)) {
    <span class="keyword">try</span> {
        <span class="predefined-type">String</span> filePath = filterConfig.getServletContext().getRealPath(configFilePath);
        CASConf.initFromDB(filePath); <img src="./images/icons/callouts/2.png" alt="2">
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">init AuthFilter from database error!</span><span class="delimiter">&quot;</span></span>, e);
    }
}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>一般，第三方集成进来时采用配置文件的方式。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>自己的子系统集成进来时则采用数据库加载的方式,方便统一管理，多子系统时不需要维护多个配置文件。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>doFilter方法中则包含了主要的控制逻辑。大致分为以下几个步骤：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>获取用户将要请求的 <em>url</em></p>
</li>
<li>
<p>检查是否为例个请求，是则放行</p>
</li>
<li>
<p>从 <em>cookie</em> 中获取用户票据，去 <em>dmcas</em> 校验用户票据是否合法</p>
</li>
<li>
<p>根据 <em>ip</em> 检验用户是否存在票据信息</p>
</li>
<li>
<p>检查请求是否为公共请求</p>
</li>
<li>
<p>无用户信息并且不是公共请求，则重定向至登录页面。否则就放行。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">doFilter</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
        <span class="directive">throws</span> <span class="exception">IOException</span>, ServletException {

    <span class="comment">// TODO 设置线程的当前request,user</span>
    HttpServletRequest hrequest = (HttpServletRequest) request;
    HttpServletResponse hresponse = (HttpServletResponse) response;

    <span class="predefined-type">String</span> path = hrequest.getServletPath();
    <span class="keyword">if</span> (StringUtils.hasText(hrequest.getPathInfo())) {
        path += hrequest.getPathInfo();
    }

    <span class="comment">// 如果为例外请求，直接通过，不通过cas获取当前登录用户</span>
    <span class="keyword">if</span> (<span class="local-variable">this</span>.isExceptRequest(path)) {
        chain.doFilter(request, response);
        <span class="keyword">return</span>;
    }

    <span class="comment">// 通过cas获取当前登录用户</span>
    <span class="comment">// 基于cookie</span>
    <span class="predefined-type">String</span> username = <span class="predefined-constant">null</span>;
    <span class="predefined-type">String</span> authid = CookieUtil.getCookie(hrequest, CASConf.getCasTicketName());

    <span class="comment">// 用户浏览器存在cookie信息</span>
    <span class="keyword">if</span> (StringUtils.hasText(authid)) {
        username = <span class="local-variable">this</span>.getAuthUser(authid); <img src="./images/icons/callouts/1.png" alt="1">
    } <span class="keyword">else</span> {
        <span class="comment">// 不存在cookie信息，根据用户ip获取票据信息</span>
        <span class="predefined-type">String</span> clientIp = IPUtil.getClientIpAddr(hrequest);
        <span class="keyword">if</span> (StringUtils.hasText(clientIp)) {
            <span class="comment">// 如果根据clientIp获取到用户信息，则认为请求通过</span>
            <span class="predefined-type">String</span> authInfo = <span class="local-variable">this</span>.getAuthInfo(clientIp); <img src="./images/icons/callouts/2.png" alt="2">
            <span class="keyword">if</span> (StringUtils.hasText(authInfo)) {
                <span class="predefined-type">String</span><span class="type">[]</span> authInfoArr = authInfo.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">&amp;</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">if</span> (authInfoArr.length &gt;= <span class="integer">2</span>) {
                    authid = authInfoArr[<span class="integer">0</span>];
                    username = authInfoArr[<span class="integer">1</span>];

                    <span class="comment">// 往用户浏览器回写当前域的cookie</span>
                    <span class="local-variable">this</span>.setCookie(hresponse, authid, username);
                } <span class="keyword">else</span> {
                    logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalid auth info:</span><span class="delimiter">&quot;</span></span> + authInfo);
                }
            }
        }
    }

    <span class="comment">// 取消基于请求参数方式, modify by zxb</span>
    <span class="comment">// TODO 登录校验</span>
    <span class="type">boolean</span> isPublicRequest = <span class="local-variable">this</span>.isPublicRequest(hrequest, path);

    <span class="keyword">if</span> (StringUtils.isEmpty(username) &amp;&amp; !isPublicRequest) {
        <span class="local-variable">this</span>.redirectView(hrequest, hresponse);
        <span class="keyword">return</span>;
    }

    chain.doFilter(<span class="keyword">new</span> CasHttpServletRequest(hrequest, username), response);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>模拟发送 <em>http</em> 请求至 <em>dmcas</em> 校验用户票据有效性</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>模拟发送 <em>http</em> 请求至 <em>dmcas</em> 根据 <em>ip</em> 获取用户信息</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>destory</em> 方法在 <em>Filter</em> 中一般是作为释放资源而存在的，此处则只留了一个空实现。</p>
</div>
</div>
<div class="sect2">
<h3 id="casconf配置"><a class="anchor" href="#casconf配置"></a>8.2. CASConf配置</h3>
<div class="paragraph">
<p><em>CASConf</em> 作为一个配置类，保存了 <em>AuthFilter</em> 中使用到的一些配置信息。同时也作为工具类，提供了加载配置信息的方法。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/dmcas-client-casconf.png" alt="dmcas client casconf">
</div>
</div>
</div>
<div class="sect2">
<h3 id="casutil-工具"><a class="anchor" href="#casutil-工具"></a>8.3. CASUtil 工具</h3>
<div class="paragraph">
<p>与第三方系统集成时，通常他们也希望能根据票据获取到具体的用户信息。而在 <em>CASUtil</em> 中就提供了该方法。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/dmcas-client-casutil.png" alt="dmcas client casutil">
</div>
</div>
<div class="paragraph">
<p>此处获取用户信息，同样是模拟发送 <em>http</em> 请求到 <em>dmcas</em> ，通过参数 <em>casauthid</em> (即票据)获取用户的具体信息。</p>
</div>
<div class="listingblock">
<div class="title">CASUtil</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 用户登录后用户信息（不包含密码）
 *
 * @param authid
 * @preserve
 * @return
 */</span>

<span class="directive">public</span> <span class="directive">static</span> User getUserInfo(<span class="predefined-type">String</span> authid) {
  <span class="comment">// 空值直接返回null</span>
  <span class="keyword">if</span> (StringUtils.isEmpty(authid)) {
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
  }
  <span class="comment">// 建立http连接并获取信息</span>
  <span class="predefined-type">String</span> userinfo = <span class="predefined-constant">null</span>;
  User user = <span class="keyword">new</span> User();
  <span class="keyword">try</span> {
    <span class="comment">// 建立connection</span>
    <span class="predefined-type">String</span> urlString = CASConf.getCasURL() + CASConf.getGetUserInfoPath() + <span class="string"><span class="delimiter">&quot;</span><span class="content">?</span><span class="delimiter">&quot;</span></span> + CASConf.getCasTicketName()
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">=</span><span class="delimiter">&quot;</span></span> + authid + <span class="string"><span class="delimiter">&quot;</span><span class="content">_userinfo</span><span class="delimiter">&quot;</span></span>;
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">CASAuthID 工具:</span><span class="delimiter">&quot;</span></span> + authid);
    <span class="predefined-type">URL</span> url = <span class="keyword">new</span> <span class="predefined-type">URL</span>(urlString);
    <span class="predefined-type">HttpURLConnection</span> connection = (<span class="predefined-type">HttpURLConnection</span>) url.openConnection();
    <span class="comment">// 设置建立连接超时时间</span>
    connection.setConnectTimeout(<span class="integer">5000</span>);
    connection.setRequestMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>);
    connection.setDoOutput(<span class="predefined-constant">true</span>);
    connection.setDoInput(<span class="predefined-constant">true</span>);
    connection.setUseCaches(<span class="predefined-constant">false</span>);
    <span class="comment">// 获取响应</span>
    connection.connect();
    <span class="predefined-type">InputStream</span> inputStream = connection.getInputStream();
    <span class="predefined-type">BufferedReader</span> reader = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(inputStream));
    userinfo = reader.readLine();
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">userinfo 工具encode:</span><span class="delimiter">&quot;</span></span> + userinfo);
    userinfo = <span class="predefined-type">URLDecoder</span>.decode(userinfo, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>);
    JSONObject jsonObject = JSONObject.fromObject(userinfo);
    user = (User) JSONObject.toBean(jsonObject, User.class);

    <span class="comment">// 关闭连接</span>
    reader.close();
    inputStream.close();
    connection.disconnect();
  } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    e.printStackTrace();
  }
  <span class="keyword">return</span> user;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="dmcas-validation" class="sect0"><a class="anchor" href="#dmcas-validation"></a>dmcas-validation</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>在 <em>dmcas</em> 升级后，原先所有放在 <em>dmcas</em> 中的用户信息校验逻辑及其它一些业务逻辑将全部从 <em>dmcas</em> 中剥离。因为这些逻辑不属于 <em>dmcas</em> 处理，应该是各子系统自己独有的一些逻辑，即应该子系统自己独立处理。</p>
</div>
<div class="paragraph">
<p>当这些校验逻辑被剥离出来后，就形成了 <em>dmcas-validation</em> 。它作为一个默认的校验实现（仅限于达梦公安团队的项目使用）。当然，各子系统也完全可以实现自己的校验逻辑，只需要遵循 <em>dmcas</em> 中指定的那些接口规范即可。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="接口"><a class="anchor" href="#接口"></a>9. 接口</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在 <em>dmcas</em> 独立出来以后，暴露了如下一些接口，子系统实现这些接口后， <em>dmcas</em> 将通过 <em>rpc</em> 的方式调用子系统的具体实现来完成校验及其它业务逻辑。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/dmcas-validation-interface.png" alt="dmcas validation interface">
</div>
<div class="title">interfaces</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">AuthService</dt>
<dd>
<p>校验服务接口，根据用户登录请求的用户名密码，子系统提供校验服务即可。注意，在子系统自己的登陆页面登陆时才会调用该接口。 <code>必须实现</code></p>
<div class="listingblock">
<div class="title">AuthService</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 检验用户信息服务
 *
 * @author zxb
 * @version 1.0.1
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">AuthService</span> {

        <span class="comment">/**
         * 校验用户名密码是否正确
         *
         * @param username 用户名
         * @param password 用户明文密码
         * @return AuthResult 校验结果
         * @see com.dm.cas.server.domain.AuthResult
         */</span>
        <span class="directive">public</span> AuthResult validate(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password);

}</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">LoginPostProcessService</dt>
<dd>
<p>登录成功后的处理接口，子系统实现该接口以便完成一些登陆成功后的处理逻辑。例如，记录登陆日志等。 <code>可选实现</code></p>
<div class="listingblock">
<div class="title">LoginPostProcessService</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 用户登录成功后，子系统的处理服务。
 * &lt;p/&gt;
 * 子系统可以实现该接口，以便在用户登录成功后，计入登录日志等信息。
 * @author zxb
 * @version 1.0.1
 * Created by zxb on 2016/3/13.
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">LoginPostProcessService</span> {

    <span class="comment">/**
     * cas验证用户登录成功后，会调用该接口。子类实现该接口后可加入自己的一些处理逻辑。
     * @param params 参数列表
     *               &lt;ul&gt;
     *                  &lt;li&gt;user 登录用户信息&lt;/li&gt;
     *                  &lt;li&gt;ip 登录用户客户端ip地址&lt;/li&gt;
     *               &lt;/ul&gt;
     * @throws Exception
     * @return ReturnMessage 返回的消息，子类如果不返回消息及状态码。cas将使用默认消息及状态码。
     */</span>
    ReturnMessage process(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span>;

}</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">LoginFailProcessService</dt>
<dd>
<p>登陆失败后的处理逻辑，子系统实现该接口后可在用户登陆失败后加入自己的一些处理逻辑。 <code>可选实现</code></p>
<div class="listingblock">
<div class="title">LoginFailProcessService</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * @author zxb
 * @version 1.0.1
 * Created by zxb on 2016/3/14.
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">LoginFailProcessService</span> {

    <span class="comment">/**
     * cas验证用户登录失败后，会调用该接口。子类实现该接口后可加入自己的一些处理逻辑。
     * @param params 参数列表
     *               &lt;ul&gt;
     *                  &lt;li&gt;user 登录用户信息&lt;/li&gt;
     *                  &lt;li&gt;ip 登录用户客户端ip地址&lt;/li&gt;
     *               &lt;/ul&gt;
     * @throws Exception
     * @return ReturnMessage 返回的消息，子类如果不返回消息及状态码。cas将使用默认消息及状态码。
     */</span>
    ReturnMessage process(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">UserMapperService</dt>
<dd>
<p>用户映射接口，用户在登陆本系统或第三方系统后，再去访问其它第三方系统时，需要提供一个用户映射的服务。子系统必须实现该接口，且提供用户的匹配映射。 <code>必须实现</code></p>
<div class="listingblock">
<div class="title">UserMapperService</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 用户接口
 * @author zxb
 * @version 1.0.1
 * Created by zxb on 2016/3/16.
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserMapperService</span> {

    <span class="comment">/**
     * 根据用户账号获取该用户的信息，子系统实现该接口，便于各系统之间完成用户映射。此处只会被 dmcas 调用，且只会用于各系统间匹配校验。
     * @param userCode 用户账号
     * @return user 用户信息
     * @throws Exception
     */</span>
    <span class="directive">public</span> User getUser(<span class="predefined-type">String</span> userCode) <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="comment">/**
     * 根据其它系统提供的用户信息，返回本系统对应的用户信息。
     * @param user
     * @return
     * @throws Exception
     */</span>
    <span class="directive">public</span> User getUser(User user) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="默认实现"><a class="anchor" href="#默认实现"></a>10. 默认实现</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在 <em>dmcas-validtion</em> 中完成的，只是对上述的几个接口的一个实现而已。</p>
</div>
<div class="sect2">
<h3 id="authservice"><a class="anchor" href="#authservice"></a>10.1. AuthService</h3>
<div class="paragraph">
<p>默认的用户名密码校验，采用的是对密码 <em>md5</em> 后进行一个比较的校验。实现逻辑很简单，把密码 <em>md5</em> 一把后和库中的 <em>md5</em> 后的密码进行一个等值比较。</p>
</div>
<div class="listingblock">
<div class="title">MD5AuthService</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> AuthResult validate(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password) {
logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">begin validate user login info! username:</span><span class="delimiter">&quot;</span></span> + username);
AuthResult authResult = <span class="keyword">new</span> AuthResult();
<span class="keyword">if</span> (!StringUtils.hasText(username) || !StringUtils.hasText(password)) {
    authResult.setValid(<span class="predefined-constant">false</span>);
    authResult.setMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">用户名或密码不能为空！</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> authResult;
}

<span class="predefined-type">Connection</span> conn = <span class="predefined-constant">null</span>;
<span class="predefined-type">PreparedStatement</span> ps = <span class="predefined-constant">null</span>;
<span class="predefined-type">ResultSet</span> rs = <span class="predefined-constant">null</span>;
<span class="keyword">try</span> {
    <span class="comment">// TODO 此处应使用连接池实现，并发登录情况下此实现会有问题。</span>
    conn = dataSource.getConnection();
    ps = conn.prepareStatement(sql);
    ps.setString(<span class="integer">1</span>, username);
    rs = ps.executeQuery();
    <span class="predefined-type">String</span> dbPassword = <span class="predefined-constant">null</span>;
    <span class="predefined-type">String</span> flag = <span class="predefined-constant">null</span>;
    <span class="keyword">while</span> (rs.next()) {
        dbPassword = rs.getString(<span class="integer">1</span>);
        flag = rs.getString(<span class="integer">2</span>);
    }
    <span class="keyword">if</span> (!StringUtils.hasText(dbPassword)) {
        authResult.setValid(<span class="predefined-constant">false</span>);
        authResult.setMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">用户不存在！</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> authResult;
    }
    <span class="keyword">if</span> (!dbPassword.equalsIgnoreCase(EncryptUtil.md5Degest(password))) {
        authResult.setValid(<span class="predefined-constant">false</span>);
        authResult.setMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">用户或密码不正确！</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> authResult;
    }
    <span class="keyword">if</span> (!(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>.equals(flag))) {
        authResult.setValid(<span class="predefined-constant">false</span>);
        authResult.setMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">帐号已被禁用！</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> authResult;
    }
    <span class="comment">//获取登录用户信息</span>
    User user = userService.queryByCodePassword(username, password);
    authResult.setUser(user);
    <span class="comment">//验证是否成功</span>
    authResult.setValid(<span class="predefined-constant">true</span>);
    <span class="keyword">return</span> authResult;
} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">validate user:</span><span class="delimiter">&quot;</span></span> + username + <span class="string"><span class="delimiter">&quot;</span><span class="content"> error!</span><span class="delimiter">&quot;</span></span>, e);
    <span class="comment">// 返回信息</span>
    authResult.setValid(<span class="predefined-constant">false</span>);
    authResult.setMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">验证失败！</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> authResult;
} <span class="keyword">finally</span> {
    <span class="local-variable">this</span>.release(rs, ps, conn);
    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">begin validate user login info! username:</span><span class="delimiter">&quot;</span></span> + username + <span class="string"><span class="delimiter">&quot;</span><span class="content">, validate:</span><span class="delimiter">&quot;</span></span> + authResult.isValid() + <span class="string"><span class="delimiter">&quot;</span><span class="content">,msg:</span><span class="delimiter">&quot;</span></span> + authResult.getMessage());
}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="loginpostprocessservice"><a class="anchor" href="#loginpostprocessservice"></a>10.2. LoginPostProcessService</h3>
<div class="paragraph">
<p>在用户登陆成功后，往往需要记录用户登陆行为的日志，刷新用户访问量等等。</p>
</div>
<div class="paragraph">
<p><em>LoginPostProcessServiceImpl</em> 实现了该接口，这里则是添加了一些子系统独有的一些逻辑。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">
<div class="paragraph">
<p>接口方法返回的 <em>ReturnMessage</em> 可以决定登陆成功后最终返回给客户端的信息，如 <em>ReturnCode</em> 和 <em>ReturnMessage</em></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">LoginPostProcessServiceImpl</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LoginPostProcessServiceImpl</span> <span class="directive">implements</span> LoginPostProcessService {

    <span class="directive">private</span> <span class="predefined-type">Logger</span> logger = <span class="predefined-type">Logger</span>.getLogger(<span class="local-variable">this</span>.getClass());

    <span class="comment">/**
     * 登录日志类型
     */</span>
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> LOGIN_LOG_TYPE = <span class="string"><span class="delimiter">&quot;</span><span class="content">1001</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">/**
     * 日志服务接口
     */</span>
    <span class="directive">private</span> LogService logService;

    <span class="comment">/**
     * 参数列表
     */</span>
    <span class="directive">private</span> ParamCache paramCache;

    <span class="directive">public</span> <span class="type">void</span> setLogService(LogService logService) {
        <span class="local-variable">this</span>.logService = logService;
    }

    <span class="directive">public</span> <span class="type">void</span> setParamCache(ParamCache paramCache) {
        <span class="local-variable">this</span>.paramCache = paramCache;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ReturnMessage process(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span> {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">begin login success process!</span><span class="delimiter">&quot;</span></span>);
        ReturnMessage returnMessage = <span class="predefined-constant">null</span>;
        <span class="keyword">if</span> (params != <span class="predefined-constant">null</span> &amp;&amp; params.size() &gt; <span class="integer">0</span>) {
            <span class="comment">// 记录用户登录日志</span>
            User user = (User) params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
            <span class="predefined-type">String</span> ip = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ip</span><span class="delimiter">&quot;</span></span>).toString();

            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">create login log, user:</span><span class="delimiter">&quot;</span></span> + user.getUser_code() + <span class="string"><span class="delimiter">&quot;</span><span class="content">, ip:</span><span class="delimiter">&quot;</span></span> + ip);
            <span class="local-variable">this</span>.logService.createLog(user, ip, LOGIN_LOG_TYPE);

            <span class="comment">// 更新门户登陆统计信息</span>
            <span class="local-variable">this</span>.logService.update();

            <span class="comment">// 验证用户密码是否为初始化密码</span>
            <span class="predefined-type">String</span> username = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>).toString();
            <span class="predefined-type">String</span> password = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>).toString();
            <span class="predefined-type">String</span> initial_password = paramCache.getValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">INITIAL_PASSWORD</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">if</span> (!StringUtils.hasText(initial_password)) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">initial_password is empty,verify password will not effect!please check the table wmf_param!</span><span class="delimiter">&quot;</span></span>);
            } <span class="keyword">else</span> {
                <span class="keyword">if</span> (EncryptUtil.md5Degest(initial_password).equalsIgnoreCase(password)) {
                    returnMessage = <span class="keyword">new</span> ReturnMessage();
                    returnMessage.setReturnCode(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>);
                    returnMessage.setReturnMsg(<span class="string"><span class="delimiter">&quot;</span><span class="content">您的密码还是初始化密码，请及时修改！</span><span class="delimiter">&quot;</span></span>);
                    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">verify success!warn, the user </span><span class="delimiter">&quot;</span></span> + username + <span class="string"><span class="delimiter">&quot;</span><span class="content">'s password is initial_password!</span><span class="delimiter">&quot;</span></span>);
                }
            }
        }
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">end login success process!</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> returnMessage;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="loginfailprocessservice"><a class="anchor" href="#loginfailprocessservice"></a>10.3. LoginFailProcessService</h3>
<div class="paragraph">
<p><em>LoginFailProcessService</em> 同 <em>LoginPostProcessService</em> 接口类似，它在用户登陆失败时会调用。</p>
</div>
<div class="paragraph">
<p><em>LoginFailProcessServiceImpl</em> 实现了该接口，添加了一些日志记录的逻辑。</p>
</div>
<div class="listingblock">
<div class="title">LoginFailProcessServiceImpl</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 登录失败后的处理逻辑
 * Created by zxb on 2016/3/14.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoginFailProcessServiceImpl</span> <span class="directive">implements</span> LoginFailProcessService {

    <span class="directive">private</span> <span class="predefined-type">Logger</span> logger = <span class="predefined-type">Logger</span>.getLogger(<span class="local-variable">this</span>.getClass());

    <span class="directive">private</span> MistakeLogService mistakeLogService;

    <span class="comment">/**
     * 登录日志类型
     */</span>
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> LOGIN_LOG_TYPE = <span class="string"><span class="delimiter">&quot;</span><span class="content">1001</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> <span class="type">void</span> setMistakeLogService(MistakeLogService mistakeLogService) {
        <span class="local-variable">this</span>.mistakeLogService = mistakeLogService;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ReturnMessage process(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span> {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">begin login fail process!</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (params != <span class="predefined-constant">null</span> &amp;&amp; params.size() &gt; <span class="integer">0</span>) {
            <span class="comment">// 创建登录失败日志</span>
            User user = (User) params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
            <span class="predefined-type">String</span> ip = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ip</span><span class="delimiter">&quot;</span></span>).toString();

            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">login fail user:</span><span class="delimiter">&quot;</span></span> + (user == <span class="predefined-constant">null</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> : user.getUser_code()) + <span class="string"><span class="delimiter">&quot;</span><span class="content">, ip:</span><span class="delimiter">&quot;</span></span> + ip);
            mistakeLogService.createLog(user, ip, LOGIN_LOG_TYPE);
        }
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">end login fail process!</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usermapperservice"><a class="anchor" href="#usermapperservice"></a>10.4. UserMapperService</h3>
<div class="paragraph">
<p><em>UserMapperService</em> 作为各子系统间互相访问时最关键的一个服务接口。它要求子系统实现它时，需要提供用户映射的服务。</p>
</div>
<div class="paragraph">
<p><em>UserMapperServiceImpl</em> 实现了该接口的两个方法。</p>
</div>
<div class="listingblock">
<div class="title">UserMapperServiceImpl</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 用户映射服务实现
 *
 * @author zxb
 * @version 1.0.1
 *          Created by zxb on 2016/3/17.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UserMapperServiceImpl</span> <span class="directive">implements</span> UserMapperService {

    <span class="directive">private</span> <span class="predefined-type">Logger</span> logger = <span class="predefined-type">Logger</span>.getLogger(<span class="local-variable">this</span>.getClass());

    <span class="comment">/**
     * 用户操作接口
     */</span>
    <span class="directive">private</span> UserService userService;

    <span class="comment">/**
     * 设置用户操作接口
     */</span>
    <span class="directive">public</span> <span class="type">void</span> setUserService(UserService userService) {
        <span class="local-variable">this</span>.userService = userService;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> User getUser(<span class="predefined-type">String</span> userCode) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">if</span> (StringUtils.hasText(userCode)) {
            User user = <span class="local-variable">this</span>.userService.queryByCode(userCode);
            <span class="keyword">return</span> user;
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> User getUser(User user) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">if</span> (user == <span class="predefined-constant">null</span> || !StringUtils.hasText(user.getUser_code())) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">user is null or user_code is empty!</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span> <span class="predefined-constant">null</span>; <img src="./images/icons/callouts/1.png" alt="1">
        }

        <span class="predefined-type">String</span> userCode = user.getUser_code();
        <span class="predefined-type">String</span> idCardNo = user.getUser_sfzh();
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">other system's user, user_code </span><span class="delimiter">&quot;</span></span> + userCode + <span class="string"><span class="delimiter">&quot;</span><span class="content">, idCardNo </span><span class="delimiter">&quot;</span></span> + idCardNo);

        <span class="comment">// 非普通用户，如一般的管理用户</span>
        <span class="keyword">if</span> (!StringUtils.hasText(idCardNo)) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">current user </span><span class="delimiter">&quot;</span></span> + userCode + <span class="string"><span class="delimiter">&quot;</span><span class="content"> does'nt has idCardNo!</span><span class="delimiter">&quot;</span></span>);
            <span class="comment">// TODO 后期再看如何处理，或者抛出一个接口，让各个我们做的系统提供实现。</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// 阻止无身份证号的用户进行访问</span>
            <span class="comment">//return user; 测试使用</span>
        }

        <span class="comment">// 本系统中映射用户不存在时，则创建用户</span>
        User mappingUser = <span class="local-variable">this</span>.userService.queryByNameSfzh(userCode, idCardNo);
        <span class="keyword">if</span> (mappingUser == <span class="predefined-constant">null</span>) {
            mappingUser = <span class="local-variable">this</span>.userService.createPkiUser(userCode, userCode, idCardNo, <span class="string"><span class="delimiter">&quot;</span><span class="content">PKI001</span><span class="delimiter">&quot;</span></span>);
        }

        <span class="keyword">return</span> mappingUser; <img src="./images/icons/callouts/2.png" alt="2">
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>没有匹配用户时，直接返回 <em>null</em> 则可以。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>存在用户，则返回匹配的用户即可。</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<h1 id="dmga-portal-hb" class="sect0"><a class="anchor" href="#dmga-portal-hb"></a>dmga-portal-hb</h1>
<div class="sect1">
<h2 id="pki登录"><a class="anchor" href="#pki登录"></a>11. pki登录</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>pki</strong>: <em>Public Key Infrastructure</em> 即 <strong>公钥基础设施</strong></p>
</div>
<div class="paragraph">
<p>在本系统中，通过 <strong>pki</strong> 进行登录，主要是获取 <strong>pki</strong> 中的用户信息。</p>
</div>
<div class="paragraph">
<p>所以登录也就是分为两步.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>获取 <strong>pki</strong> 证书代表的用户信息，警号、身份证号</p>
</li>
<li>
<p>使用 警号、身份证号 进行登陆</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="引入类库"><a class="anchor" href="#引入类库"></a>11.1. 引入类库</h3>
<div class="paragraph">
<p>在集成 <strong>pki</strong> 登录前，需要在 <strong>portal</strong> 工程下引入以下类库。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commons-codec-1.3.jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">字节编码库；</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commons-httpclient-3.1.jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Http客户端；</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commons-logging-1.1.jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日志接口；</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IAS_SDK_2.1_JDK13.jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">（可选）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于兼容2.1及以前版本的支持包，如果使用2.1以上版本，可以不引用。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IAS_SDK_2.2.0_JDK13.jar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">开发工具包；</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log4j-1.2.14.jar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">日志包；</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jit-cinas-saml11-1000-jdk13.jar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAML 1.1协议支持包；</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jit-cinas-commons-1000-jdk13.jar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">产品公共类库；</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Xmlsec-1.3.0.jar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML签名加密包；</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">log4j-1.2.14.jar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">第三日志包；</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">J2EE_Agent_2_2_2_JDK13.jar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Agent功能包</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bcprov-jdk13-143.jar</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="pki-jsp编写"><a class="anchor" href="#pki-jsp编写"></a>11.2. pki.jsp编写</h3>
<div class="paragraph">
<p>编写 <em>pki.jsp</em> 完成用户信息的获取。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;%<span class="error">@</span> page language=<span class="string"><span class="delimiter">&quot;</span><span class="content">java</span><span class="delimiter">&quot;</span></span> pageEncoding=<span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> page contentType=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/html; charset=utf-8</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> page <span class="keyword">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cn.com.jit.assp.ias.sp.saml11.SPUtil</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> <span class="include">page</span> <span class="include">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cn.com.jit.assp.ias.sp.saml11.SPConst</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> <span class="include">page</span> <span class="include">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cn.com.jit.assp.ias.saml.saml11.*</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> <span class="include">page</span>
        <span class="include">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cn.com.jit.assp.ias.saml.saml11.SAMLAttributes.SAMLAttributeName</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> <span class="include">page</span> <span class="include">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cn.com.jit.assp.ias.principal.UserPrincipal</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> <span class="include">page</span> <span class="include">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.text.SimpleDateFormat</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> <span class="include">page</span> <span class="include">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.util.*</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%<span class="error">@</span> <span class="include">page</span> <span class="include">import</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cn.com.jit.cinas.commons.util.StringUtils</span><span class="delimiter">&quot;</span></span>%&gt;
&lt;%
        <span class="include">boolean</span> <span class="include">success</span> = <span class="include">false</span>;
        UserPrincipal p = <span class="predefined-constant">null</span>;
        <span class="predefined-type">SimpleDateFormat</span> formatter = <span class="keyword">new</span> <span class="predefined-type">SimpleDateFormat</span>(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">yyyy��MM��dd�� HH:mm:ss</span><span class="delimiter">&quot;</span></span>);

        p = SPUtil.getUserPrincipal(request);

        success = (p == <span class="predefined-constant">null</span> ? <span class="predefined-constant">false</span> : <span class="predefined-constant">true</span>);
        <span class="predefined-type">String</span> user_name = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> user_sfzh = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

        SAMLAttributes attrs = (SAMLAttributes)p.getAttribute(SPConst.KEY_SAML_ATTR_STATEMENT_ATTRIBUTES);
        <span class="predefined-type">String</span> info = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
        <span class="keyword">if</span> (attrs != <span class="predefined-constant">null</span>) {
                <span class="predefined-type">List</span> ls = attrs.getAttributeNames();
                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; ls.size(); i++) {
                        SAMLAttributeName name = (SAMLAttributeName) ls.get(i);
                        <span class="comment">// ȡ�ø�����ֵ</span>
                        <span class="predefined-type">String</span> parentValueName = name.getParentName();
                        <span class="predefined-type">List</span> values = <span class="predefined-constant">null</span>;
                        <span class="keyword">if</span> (!StringUtils.isBlankOrNull(parentValueName))
                                <span class="comment">// ��&quot;���ֵ�&quot;��������ʱ</span>
                                values = attrs.getAttributeValue(name.getName(),name.getNamespace(),parentValueName);
                        <span class="keyword">else</span>
                                values = attrs.getAttributeValue(name.getName(),name.getNamespace());
                        <span class="keyword">if</span>(values!= <span class="predefined-constant">null</span>&amp;&amp;values.size()&gt;<span class="integer">0</span>) {
                                info = values.get(<span class="integer">0</span>).toString();
                        }
                }
        }
        <span class="predefined-type">String</span> pki_info = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
        <span class="keyword">if</span>(info != <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>){
                pki_info = info.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>)[<span class="integer">0</span>].split(<span class="string"><span class="delimiter">&quot;</span><span class="content">=</span><span class="delimiter">&quot;</span></span>)[<span class="integer">1</span>];
        }
        <span class="keyword">if</span>(pki_info.split(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>).length&gt;=<span class="integer">2</span>){
                pki_info = pki_info.split(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>)[<span class="integer">0</span>]+<span class="string"><span class="delimiter">&quot;</span><span class="content">_</span><span class="delimiter">&quot;</span></span>+pki_info.split(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>)[<span class="integer">1</span>];
        }

        response.sendRedirect(<span class="string"><span class="delimiter">&quot;</span><span class="content">../information.shtml?status_flag=</span><span class="delimiter">&quot;</span></span>+success+<span class="string"><span class="delimiter">&quot;</span><span class="content">&amp;pki_info=</span><span class="delimiter">&quot;</span></span>+java.net.URLEncoder.encode(pki_info)); <img src="./images/icons/callouts/1.png" alt="1">
%&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>注意，重定向首页时，此时已经获取到了用户信息，即参数中的 <strong><em>pki_info</em></strong></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="配置过滤器-2"><a class="anchor" href="#配置过滤器-2"></a>11.3. 配置过滤器</h3>
<div class="paragraph">
<p>上面编写的 <em>pki.jsp</em> 中获取到的用户信息，实际上是在 <em>filter</em> 中完成后再转给 <em>pki.jsp</em> 的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;filter&gt;</span>
                <span class="tag">&lt;filter-name&gt;</span>AccessController<span class="tag">&lt;/filter-name&gt;</span>
                <span class="tag">&lt;filter-class&gt;</span>
                        cn.com.jit.assp.ias.sp.saml11.AccessController
                <span class="tag">&lt;/filter-class&gt;</span>
                <span class="tag">&lt;init-param&gt;</span>
                        <span class="tag">&lt;param-name&gt;</span>SPConfig<span class="tag">&lt;/param-name&gt;</span>
                        <span class="tag">&lt;param-value&gt;</span>
                                /WEB-INF/config/JITAgentConfig.xml <img src="./images/icons/callouts/1.png" alt="1">
                        <span class="tag">&lt;/param-value&gt;</span>
                <span class="tag">&lt;/init-param&gt;</span>
        <span class="tag">&lt;/filter&gt;</span>
        <span class="tag">&lt;filter-mapping&gt;</span>
                <span class="tag">&lt;filter-name&gt;</span>AccessController<span class="tag">&lt;/filter-name&gt;</span>
                <span class="tag">&lt;url-pattern&gt;</span>/html/pki/pki.jsp<span class="tag">&lt;/url-pattern&gt;</span> <img src="./images/icons/callouts/2.png" alt="2">
        <span class="tag">&lt;/filter-mapping&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>指向了对应的 <strong>pki</strong> 的配置文件，里面包含了验证服务器地址等信息。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>拦截了 <strong><em>pki.jsp</em></strong> 。这里需要注意的是，如果 <strong><em>pki.jsp</em></strong> 所在的 <em>uri</em> 如果不在 <strong>吉大正元信任列表</strong> 中。此时访问会报错提示不在信任列表中。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="登录请求"><a class="anchor" href="#登录请求"></a>11.4. 登录请求</h3>
<div class="paragraph">
<p>请求流程如下图</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/pki.png" alt="pki">
</div>
</div>
<div class="paragraph">
<p>由图可以看出， <em>pki</em> 只是为了获取用户信息，然后再发请求完成用户登陆。</p>
</div>
</div>
</div>
</div>
<h1 id="dmga-dubbo-wsdl" class="sect0"><a class="anchor" href="#dmga-dubbo-wsdl"></a>dmga-dubbo-wsdl</h1>
<div class="sect1">
<h2 id="简述"><a class="anchor" href="#简述"></a>12. 简述</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="概要说明"><a class="anchor" href="#概要说明"></a>12.1. 概要说明</h3>
<div class="paragraph">
<p>在基于 <em>rpc</em> 框架 <em>dubbo</em> 的基础上构建的 <em>soa</em> 并不能直接接入第三方的 <em>webservice</em> 服务。而公安内部的接口通讯则主要是以 <em>webservice</em> 进行通讯，此时就需要开发一个工具包，完成 <em>webservice</em> 服务的接入。</p>
</div>
</div>
<div class="sect2">
<h3 id="实现框架"><a class="anchor" href="#实现框架"></a>12.2. 实现框架</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>dubbo</em> </dt>
<dd>
<p><em>dubbo</em> 是阿里开源出来的一个优秀的 <em>rpc</em> 框架，而且该框架被许多大的电商网站使用。本工程主要是基于 <em>dubbo</em> 之上，对其进行部分扩展。</p>
</dd>
<dt class="hdlist1"><em>cxf</em> </dt>
<dd>
<p><em>cxf</em> 是一个优秀的 <em>webservice</em> 框架。本工程将基于它发布 <em>webservice</em> 服务。</p>
</dd>
<dt class="hdlist1"><em>axis</em> </dt>
<dd>
<p><em>axis</em> 同样也是一个 <em>webservice</em> 框架。由于公安部使用的是 <em>axis1.4</em> 发布的 <em>webservice</em> 服务，为了支持这类 <em>webservice</em> 服务，所以同样也引入了 <em>axis1.4</em> 来完成对该类服务的调用。</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="实现概览"><a class="anchor" href="#实现概览"></a>12.3. 实现概览</h3>
<div class="paragraph">
<p>本工程在第三方 <em>webservice</em> 服务与 <em>dubbo</em> 提供的 <em>webservice</em> 服务之间充当了一个代理。</p>
</div>
<div class="paragraph">
<p>实际上可以理解为， <strong>消费者</strong> 调用 <strong><em>dubbo</em></strong> 提供的 <strong><em>webservice</em></strong> 服务，而 <strong><em>dubbo</em></strong> 则调用第三方的 <strong><em>webservice</em></strong> 服务。如下图：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/flow.png" alt="flow">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="代码说明"><a class="anchor" href="#代码说明"></a>13. 代码说明</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本工程依赖于 <em>dmga-dubbo-service</em> 工程，部分使用的 <em>interface</em> 及 <em>domain entity</em> 均在该工程下。</p>
</div>
<div class="sect2">
<h3 id="包图及描述"><a class="anchor" href="#包图及描述"></a>13.1. 包图及描述</h3>
<div class="imageblock">
<div class="content">
<img src="./images/wsdl_package.png" alt="wsdl package">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/wsdl_package2.png" alt="wsdl package2">
</div>
</div>
<div class="hdlist">
<div class="title">包说明</div>
<table>
<tr>
<td class="hdlist1">
service
</td>
<td class="hdlist2">
<p>抽象的服务接口</p>
</td>
</tr>
<tr>
<td class="hdlist1">
service.impl
</td>
<td class="hdlist2">
<p>服务实现类</p>
</td>
</tr>
<tr>
<td class="hdlist1">
util
</td>
<td class="hdlist2">
<p>工具包</p>
</td>
</tr>
<tr>
<td class="hdlist1">
intercept.service
</td>
<td class="hdlist2">
<p>拦截器接口</p>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="各功能模块说明"><a class="anchor" href="#各功能模块说明"></a>14. 各功能模块说明</h2>
<div class="sectionbody">
<div class="olist arabic">
<div class="title">整个工程主要分为三个模块。</div>
<ol class="arabic">
<li>
<p><em>ws</em> 服务的注册</p>
</li>
<li>
<p><em>ws</em> 服务的调用</p>
</li>
<li>
<p><em>wsdl</em> 文档解析</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">
<strong><em>ws</em> 服务的注册与调用</strong> 一起完成了 <em>ws</em> 服务的代理工作。而 <strong><em>wsdl</em> 文档解析</strong> 则是提供给调用者的一个工具类接口。
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="em-ws-em-服务的注册"><a class="anchor" href="#em-ws-em-服务的注册"></a>14.1. <em>ws</em> 服务的注册</h3>
<div class="sect3">
<h4 id="类图"><a class="anchor" href="#类图"></a>14.1.1. 类图</h4>
<div class="imageblock">
<div class="content">
<img src="./images/Registry.png" alt="Registry">
</div>
</div>
</div>
<div class="sect3">
<h4 id="加载ws配置信息"><a class="anchor" href="#加载ws配置信息"></a>14.1.2. 加载ws配置信息</h4>
<div class="paragraph">
<p>默认的一些ws配置信息是由 <em>spring</em> 配置文件中注入进来的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RegistryServiceImpl</span> <span class="directive">implements</span> RegistryService, BeanFactoryPostProcessor {
    <span class="comment">/**
     * 服务提供方环境
     */</span>
    <span class="directive">private</span> Environment env;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultEnv</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.dm.dubbo.wsdl.registry.domain.Environment</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">registryAddress</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">zookeeper://localhost:1234</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/property&gt;</span> <img src="./images/icons/callouts/1.png" alt="1">
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">webservice</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolPort</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8081</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/property&gt;</span> <img src="./images/icons/callouts/2.png" alt="2">
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolServer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jetty</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/property&gt;</span> <img src="./images/icons/callouts/3.png" alt="3">
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">appName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WsGenericService</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- 定义注册wsdl服务实现 --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">registryService</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.dm.dubbo.wsdl.registry.service.impl.RegistryServiceImpl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">env</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultEnv</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <img src="./images/icons/callouts/4.png" alt="4">
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>定义注册中心的连接地址，新注册的 <em>ws</em> 服务将会连接该注册中心</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>定义发布的 <em>ws</em> 服务发布到哪个端口。 <strong>不同的 <em>ws</em> 服务应该指定不同的端口</strong></td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>定义发布 <em>ws</em> 服务采用的容器，可选 <em>jetty</em> 和 <em>servlet</em> ，此处 <em>servlet</em> 指的是tomcat容器。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>此处将上面配置的环境信息注入到 <strong>注册service</strong> 中</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="动态生成接口"><a class="anchor" href="#动态生成接口"></a>14.1.3. 动态生成接口</h4>
<div class="paragraph">
<p>当发布不同的 <em>wsdl</em> 的 <em>webservice</em> 服务时，为了在 <em>dubbo</em> 及 <em>cxf</em> 中显示不同的接口，此时需要动态生成接口。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<img src="./images/icons/important.png" alt="Important">
</td>
<td class="content">
<div class="title">注意</div>
<div class="paragraph">
<p>在 <em>dubbo</em> 中，如果 <em>interface name</em> 相同，那么需要设置不同的 <em>group name</em> 来保证是不同的服务。</p>
</div>
<div class="paragraph">
<p><strong>而在 <em>cxf</em> 中，如果 <em>interface name</em> 相同，那么是不能重复发布的，</strong> 此时就必须要动态生成接口。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">动态生成接口思路</div>
<div class="paragraph">
<p>使用 <em>asm</em> 框架生成 <em>interface</em> 的 <em>bytecode</em> 写成 <em>class</em> 文件，而此 <em>interface</em> 只需要是继承现有的 <em>GenericService</em> 即可。</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">GenericService</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * dubbo注册wsdl服务代理
 * @author zxb
 * 2016年3月3日 上午11:15:34
 */</span>
<span class="annotation">@WebService</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">GenericService</span> {

        <span class="comment">/**
         * 通过此接口请求代理方，然后调用提供方的ws服务
         * @param methodName
         * @param condition
         * @return
         * @throws Exception
         */</span>
        <span class="directive">public</span> <span class="predefined-type">Object</span> query(<span class="predefined-type">String</span> methodName, <span class="predefined-type">String</span> condition) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">generate interface code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 为该wsdl生成一个对应的接口
 *
 * @param wsEnv ws环境信息
 * @return 接口类
 * @throws ClassNotFoundException 加载的接口类未找到时抛出
 */</span>
<span class="directive">private</span> <span class="predefined-type">Class</span> generateInterface(WsEnvironment wsEnv) <span class="directive">throws</span> <span class="exception">ClassNotFoundException</span> {
    <span class="comment">// 获取上下文的类加载器</span>
    <span class="predefined-type">ClassLoader</span> classLoader = <span class="predefined-type">Thread</span>.currentThread().getContextClassLoader();
    <span class="predefined-type">String</span> classpath = classLoader.getResource(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).getPath(); <span class="comment">// 获取classpath绝对uri</span>
    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">current classpath:</span><span class="delimiter">&quot;</span></span> + classpath);

    <span class="comment">// 生成接口文件</span>
    <span class="predefined-type">File</span> interfaceClassFile = <span class="keyword">new</span> <span class="predefined-type">File</span>(classpath + <span class="string"><span class="delimiter">&quot;</span><span class="content">/com/dm/dubbo/wsdl/registry/service/</span><span class="delimiter">&quot;</span></span> + wsEnv.getInterfaceName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">.class</span><span class="delimiter">&quot;</span></span>);
    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">interfaceClassFile:</span><span class="delimiter">&quot;</span></span> + interfaceClassFile);

    <span class="keyword">if</span> (!interfaceClassFile.exists()) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">interfaceClassFile:</span><span class="delimiter">&quot;</span></span> + interfaceClassFile.getName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">does't exists! begin generate class file!</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">FileOutputStream</span> fos = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            <span class="comment">// 生成一个继承于GenericService的接口</span>
            ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="integer">0</span>);
            cw.visit(V1_5, ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE,
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">com/dm/dubbo/wsdl/registry/service/</span><span class="delimiter">&quot;</span></span> + wsEnv.getInterfaceName(), <span class="predefined-constant">null</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">java/lang/Object</span><span class="delimiter">&quot;</span></span>,
                    <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span>{<span class="string"><span class="delimiter">&quot;</span><span class="content">com/dm/dubbo/wsdl/registry/service/GenericService</span><span class="delimiter">&quot;</span></span>});
            cw.visitEnd();

            <span class="comment">// 写成class文件</span>
            interfaceClassFile.getParentFile().mkdirs();
            fos = <span class="keyword">new</span> <span class="predefined-type">FileOutputStream</span>(interfaceClassFile);
            fos.write(cw.toByteArray());
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">generate class file:</span><span class="delimiter">&quot;</span></span> + interfaceClassFile.getName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> error!</span><span class="delimiter">&quot;</span></span>, e);
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (fos != <span class="predefined-constant">null</span>) {
                <span class="keyword">try</span> {
                    fos.close();
                } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                    logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">close file output stream error! class file:</span><span class="delimiter">&quot;</span></span> + interfaceClassFile.getName(), e);
                }
            }
        }
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">interfaceClassFile:</span><span class="delimiter">&quot;</span></span> + interfaceClassFile.getName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> generate success! write into </span><span class="delimiter">&quot;</span></span> + interfaceClassFile);
    }

    <span class="comment">// 加载class入classLoader</span>
    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">begin load interface class </span><span class="delimiter">&quot;</span></span> + interfaceClassFile.getName());
    <span class="predefined-type">Class</span> dynamicInterfaceClass = classLoader.loadClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.dm.dubbo.wsdl.registry.service.</span><span class="delimiter">&quot;</span></span> + wsEnv.getInterfaceName());
    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">end load interface class </span><span class="delimiter">&quot;</span></span> + interfaceClassFile.getName());
    <span class="keyword">return</span> dynamicInterfaceClass;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面代码可以看出，生成接口主要分为以下几步</p>
</div>
<div class="ulist">
<ul>
<li>
<p>根据 <em>classloader</em> 获取 <em>classpath</em> 绝对 <strong><em>URI</em></strong></p>
</li>
<li>
<p>生成一个继承自 <em>GenericService</em> 的接口</p>
</li>
<li>
<p>将生成的接口写入 <em>classpath</em> 下对应的 <em>class</em> 文件</p>
</li>
<li>
<p>使用 <em>classloader</em> 将刚才生成的接口对应的 <em>class</em> 文件加载到jvm</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">
<div class="paragraph">
<p>先前尝试过使用 <strong><em>gclib</em></strong> 的 <em>interface maker</em> 来完成 <em>interface</em> 的动态生成。后来在 <em>dubbo</em> 框架中生成该 <em>interface</em> 的 <em>wrapper</em> 时一直报错：
javassist : [compare source error] no such class</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="动态生成实现类"><a class="anchor" href="#动态生成实现类"></a>14.1.4. 动态生成实现类</h4>
<div class="paragraph">
<p>虽然动态生成了接口，但是已经的 <em>GenericService</em> 接口的实现类 <em>GenericServiceAxis1Impl</em> 与 <em>GenericServiceCxfImpl</em> 是没有实现动态接口的。所以此时还需要这两个实现类也能实现动态接口。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">实现思路</div>
<div class="paragraph">
<p>此时动态实现类有两种解决思路。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">代理实现类</dt>
<dd>
<p>通过 <em>gclib</em> 生成现有的实现类的子类，同时实现 <em>dynamic interface</em></p>
</dd>
<dt class="hdlist1">持有实现类引用</dt>
<dd>
<p>直接通过 <em>gclib</em> 生成 <em>dynamic interface</em> 的实现类（ <strong>实际代理类</strong> ），在该 <strong>代理</strong> 类中维持一个具体实现类的引用。当调用具体的接口方法时， <strong>代理</strong> 类则调用具体实现类的该方法。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
    * 生成动态接口的实现类
    *
    * @param wsEnv            ws环境上下文
    * @param dynamicInterface 动态接口
    * @return 接口实现类
    * @throws ClassNotFoundException
    * @throws InstantiationException
    * @throws IllegalAccessException
    * @throws java.lang.reflect.InvocationTargetException
    */</span>
   <span class="directive">private</span> GenericService getGenericService(WsEnvironment wsEnv, <span class="directive">final</span> <span class="predefined-type">Class</span> dynamicInterface) <span class="directive">throws</span> <span class="exception">ClassNotFoundException</span>, <span class="exception">InstantiationException</span>, <span class="exception">IllegalAccessException</span>, java.lang.reflect.InvocationTargetException {
       <span class="comment">// 获取clientClass实例，即具体的ws调用实例</span>
       logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">begin get </span><span class="delimiter">&quot;</span></span> + wsEnv.getClientClassName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">'s instance!</span><span class="delimiter">&quot;</span></span>);
       <span class="predefined-type">Constructor</span>&lt;GenericService&gt; cons = (<span class="predefined-type">Constructor</span>&lt;GenericService&gt;) ClassUtils.getConstructorIfAvailable(
               ClassUtils.forName(wsEnv.getClientClassName(), <span class="predefined-type">Thread</span>.currentThread().getContextClassLoader()),
               WsEnvironment.class, <span class="predefined-type">List</span>.class);
       <span class="directive">final</span> GenericService genericService = cons.newInstance(wsEnv, <span class="local-variable">this</span>.interceptList);
       logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">get </span><span class="delimiter">&quot;</span></span> + wsEnv.getClientClassName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">'s instance success!</span><span class="delimiter">&quot;</span></span>);

       <span class="comment">// 生成动态接口的实现类</span>
       logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">begin generate </span><span class="delimiter">&quot;</span></span> + dynamicInterface.getName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">'s implementation class</span><span class="delimiter">&quot;</span></span>);
       Enhancer enhancer = <span class="keyword">new</span> Enhancer();
       enhancer.setInterfaces(<span class="keyword">new</span> <span class="predefined-type">Class</span><span class="type">[]</span>{dynamicInterface});
       enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() {
           <span class="directive">public</span> <span class="predefined-type">Object</span> intercept(<span class="predefined-type">Object</span> obj, <span class="predefined-type">Method</span> method, <span class="predefined-type">Object</span><span class="type">[]</span> args, MethodProxy proxy) <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
               <span class="keyword">if</span> (method.getName().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">query</span><span class="delimiter">&quot;</span></span>)) { <img src="./images/icons/callouts/1.png" alt="1">
                   <span class="keyword">return</span> genericService.query(args[<span class="integer">0</span>].toString(), args[<span class="integer">1</span>].toString()); <span class="comment">// 调用具体的clientClass实例的方法。</span>
               }
               <span class="keyword">return</span> method.invoke(obj, args);
           }
       });
       GenericService proxyService = (GenericService) enhancer.create();
       logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">generate </span><span class="delimiter">&quot;</span></span> + dynamicInterface.getName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">'s implementation class success! proxy class name </span><span class="delimiter">&quot;</span></span> + proxyService.getClass().getName());
       <span class="keyword">return</span> proxyService;
   }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>拦截 <strong>代理</strong> 类的 <strong><em>query</em></strong> 方法,调用 <strong>具体实现类</strong> 的 <em>query</em> 方法。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="服务缓存"><a class="anchor" href="#服务缓存"></a>14.1.5. 服务缓存</h4>
<div class="paragraph">
<p>由于每次发布的服务对象实例非常重，所以需要将该服务缓存起来，以备后用。这里直接通过写了一个本地 <em>cache</em> 来实现。</p>
</div>
<div class="sect4">
<h5 id="服务对象缓存"><a class="anchor" href="#服务对象缓存"></a>服务对象缓存</h5>
<div class="listingblock">
<div class="title">code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 服务缓存
 */</span>
<span class="directive">private</span> <span class="predefined-type">Map</span>&lt;Environment, ServiceConfig&gt; serviceCache = <span class="keyword">new</span> <span class="predefined-type">ConcurrentHashMap</span>&lt;Environment, ServiceConfig&gt;();

<span class="comment">// 暴露及注册服务</span>
service.setInterface(dynamicInterface);
service.setRef(proxyService); <span class="comment">// 真正的服务实现</span>
service.setVersion(wsEnv.getVersion());
service.export();

<span class="comment">// 缓存服务</span>
serviceCache.put(wsEnv, service);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="处理重复发布的服务"><a class="anchor" href="#处理重复发布的服务"></a>处理重复发布的服务</h5>
<div class="paragraph">
<p>通过现有的服务 <em>cache</em> ，完成阻止重复服务的发布。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ServiceConfig serviceConfig = serviceCache.get(context);
<span class="keyword">if</span> (serviceConfig != <span class="predefined-constant">null</span>) {
    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">deploy a duplicate service, contextAppName:</span><span class="delimiter">&quot;</span></span> + context.getAppName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">, contextRegistryAddress:</span><span class="delimiter">&quot;</span></span> + context.getRegistryAddress());
    <span class="keyword">return</span> <span class="keyword">new</span> RegistryMessage(ReturnStatus.OTHER, <span class="string"><span class="delimiter">&quot;</span><span class="content">服务已存在，请勿重复发布！</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>同时，在具体的服务发布时，使用了同步代码块防止多线程并发时重复发布服务。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">synchronized</span> (RegistryServiceImpl.class) {
            serviceConfig = serviceCache.get(context);
            <span class="keyword">if</span> (serviceConfig != <span class="predefined-constant">null</span>) {
                logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">deploy a duplicate service, contextAppName:</span><span class="delimiter">&quot;</span></span> + context.getAppName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">, wsdl:</span><span class="delimiter">&quot;</span></span> + wsEnv.getWsdlAddress());
                <span class="keyword">return</span> <span class="keyword">new</span> RegistryMessage(ReturnStatus.OTHER, <span class="string"><span class="delimiter">&quot;</span><span class="content">服务已存在，请勿重复发布！</span><span class="delimiter">&quot;</span></span>);
            }

            <span class="comment">// 发布服务</span>
            serviceConfig.export();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>由代码可以看出，服务是否重复取决于 <em>cache</em> 中的 <em>key</em> 是否相等。
因此在 <em>Environment</em> 与 <em>WsEnvironment</em> 中重写了 <em>hashcode</em> 与 <em>equals</em> 方法。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="服务配置"><a class="anchor" href="#服务配置"></a>14.1.6. 服务配置</h4>
<div class="paragraph">
<p>在线上测试过程中，出现过一些如连接超时等问题。所以在代码中也添加了部分配置。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 服务提供者协议配置</span>
ProtocolConfig protocol = <span class="keyword">new</span> ProtocolConfig();
protocol.setName(env2use.getProtocolName());
protocol.setPort(env2use.getProtocolPort());
protocol.setServer(env2use.getProtocolServer());
protocol.setAccepts(<span class="integer">500</span>); <span class="comment">// 可接受的长连接为500个</span>

<span class="comment">// 服务提供者暴露服务配置</span>
ServiceConfig&lt;GenericService&gt; service = <span class="keyword">new</span> ServiceConfig&lt;GenericService&gt;(); <span class="comment">// 此实例很重，封装了与注册中心的连接，请自行缓存，否则可能造成内存和连接泄漏</span>
service.setApplication(application);
service.setRegistry(registry); <span class="comment">// 多个注册中心可以用setRegistries()</span>
service.setProtocol(protocol); <span class="comment">// 多个协议可以用setProtocols()</span>
service.setGroup(wsEnv.getGroup());
service.setTimeout(<span class="integer">3000</span>); <span class="comment">//远程调用超时时间 </span><img src="./images/icons/callouts/1.png" alt="1">
service.setRetries(<span class="integer">0</span>); <span class="comment">//远程调用失败重试次数</span>
service.setLoadbalance(<span class="string"><span class="delimiter">&quot;</span><span class="content">roundrobin</span><span class="delimiter">&quot;</span></span>); <span class="comment">// 设置负载为轮循方式</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td><em>timeout</em> 时间建议设大一些。否则调用方可能会收到一些 <em>TimeOut</em> 相关的异常。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="em-ws-em-服务的调用"><a class="anchor" href="#em-ws-em-服务的调用"></a>14.2. <em>ws</em> 服务的调用</h3>
<div class="paragraph">
<p>本工程中通过发布出去的 <em>webservice</em> 服务来反向调用第三方的 <em>webservice</em> 服务。</p>
</div>
<div class="sect3">
<h4 id="类图-2"><a class="anchor" href="#类图-2"></a>14.2.1. 类图</h4>
<div class="imageblock">
<div class="content">
<img src="./images/wsdl_client_class.png" alt="wsdl client class">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><em>GenericServiceAxis1Impl</em></strong> 完成对 <em>axis1.4</em> 提供的 <em>webservice</em> 服务的调用</p>
</li>
<li>
<p><strong><em>GenericServiceCxfImpl</em></strong> 完成对 <em>cxf</em> 、 <em>axis1.6</em> 提供的 <em>webservice</em> 服务的调用</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="strong-em-cxf-em-strong-调用"><a class="anchor" href="#strong-em-cxf-em-strong-调用"></a>14.2.2. <strong><em>CXF</em></strong> 调用</h4>
<div class="paragraph">
<p><em>cxf</em> 的调用是直接用 <em>cxf</em> 的客户端来完成 <em>webservcie</em> 的调用 的。 <em>cxf</em> 客户端又分成 静态调用（生成代码） 与 动态调用 两种方式，此处采用的是 <strong>动态生成客户端代码</strong> 并调用的方式。</p>
</div>
<div class="listingblock">
<div class="title">代码实现</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 获取Client</span>
Client client = WsdlUtil.getCxfClient(<span class="local-variable">super</span>.wsContext.getWsdlAddress()); <img src="./images/icons/callouts/1.png" alt="1">
Assert.notNull(client);

<span class="comment">// 添加消息拦截器</span>
client.getOutInterceptors().add(<span class="keyword">new</span> LoggingOutInterceptor());
client.getInInterceptors().add(<span class="keyword">new</span> LoggingInInterceptor());

<span class="predefined-type">Object</span><span class="type">[]</span> result = client.invoke(methodName, params.values().toArray());
<span class="keyword">return</span> result[<span class="integer">0</span>]; <img src="./images/icons/callouts/2.png" alt="2"></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>获取client，此处是写地本地 <em>cache</em> 来获取客户端的，它实现是通过 <em>JaxWsDynamicClientFactory</em> 来创建客户端的。</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>此处目前没有考虑返回结果的类型，这里需要分析 <em>wsdl</em> 中对应方法的返回类型。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="strong-em-axis1-4-em-strong-调用"><a class="anchor" href="#strong-em-axis1-4-em-strong-调用"></a>14.2.3. <strong><em>axis1.4</em></strong> 调用</h4>
<div class="paragraph">
<p><em>axis1.4</em> 的调用也是直接通过 <em>axis1.4</em> 的客户端来完成调用的。当时考虑采用 <em>soapui</em> <sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup> 的实现，出于时间问题，最后放弃了。</p>
</div>
<div class="listingblock">
<div class="title">代码实现</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Object</span> doQuery(<span class="predefined-type">String</span> methodName, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span> {
  <span class="keyword">return</span> Axis1ClientUtil.invoke(<span class="local-variable">super</span>.wsContext.getWsdlAddress(), methodName,
      (<span class="predefined-type">LinkedHashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;) params);
} <img src="./images/icons/callouts/1.png" alt="1">

<span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">Object</span> invoke(<span class="predefined-type">String</span> wsdl, <span class="predefined-type">String</span> methodName, <span class="predefined-type">LinkedHashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) <span class="directive">throws</span> <span class="exception">Exception</span> {
  Call call = Axis1ClientUtil.initCall(wsdl, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>); <img src="./images/icons/callouts/2.png" alt="2">
  call.setOperationName(methodName); <img src="./images/icons/callouts/3.png" alt="3">

  <span class="comment">// 设置参数</span>
  <span class="predefined-type">Object</span><span class="type">[]</span> objArr = <span class="keyword">new</span> <span class="predefined-type">Object</span>[<span class="integer">0</span>];
  <span class="keyword">if</span> (params != <span class="predefined-constant">null</span> &amp;&amp; params.size() &gt; <span class="integer">0</span>) {
    objArr = <span class="keyword">new</span> <span class="predefined-type">Object</span>[params.size()];

    <span class="type">int</span> i = <span class="integer">0</span>;
    <span class="keyword">for</span> (Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; param : params.entrySet()) {
      call.addParameter(param.getKey(), Constants.XSD_ANY, ParameterMode.IN);
      objArr[i] = param.getValue();
      i++;
    }
  } <img src="./images/icons/callouts/4.png" alt="4">
  <span class="keyword">return</span> call.invoke(objArr);  <img src="./images/icons/callouts/5.png" alt="5">
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>调用工具类完成 <em>ws</em> 调用</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>根据 <em>wsdl</em> 地址初始化 <em>Call</em></td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td>设置要调用的 <em>ws</em> 方法</td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>设置 <em>arguments</em></td>
</tr>
<tr>
<td><img src="./images/icons/callouts/5.png" alt="5"></td>
<td>完成调用并返回结果</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="em-ws-em-服务拦截"><a class="anchor" href="#em-ws-em-服务拦截"></a>14.3. <em>ws</em> 服务拦截</h3>
<div class="paragraph">
<p>在调用第三方的 <em>ws</em> 服务时，通常需要记录请求方的 <em>ip</em> 等作为日志信息。此处为了方便后期的扩展，对 <em>ws</em> 调用请求的前后添加了额外处理，可以实现请求调用拦截，处理调用结果等。</p>
</div>
<div class="sect3">
<h4 id="类图-3"><a class="anchor" href="#类图-3"></a>14.3.1. 类图</h4>
<div class="imageblock">
<div class="content">
<img src="./images/Intercept.png" alt="Intercept">
</div>
</div>
</div>
<div class="sect3">
<h4 id="实现思路"><a class="anchor" href="#实现思路"></a>14.3.2. 实现思路</h4>
<div class="paragraph">
<p>在注册 <em>ws</em> 服务到 <em>dubbo</em> 时，将实现了指定接口的实现类注入到调用 <em>client</em> 实现中。在 <em>client</em> 调用第三方 <em>ws</em> 服务请求的前后添加拦截逻辑。</p>
</div>
</div>
<div class="sect3">
<h4 id="实现细节-3"><a class="anchor" href="#实现细节-3"></a>14.3.3. 实现细节</h4>
<div class="paragraph">
<p>所有需要定义为拦截服务的类，只需要实现 <em>InterceptService</em> 或 <em>PostProcessService</em> 或 <em>PreProcessService</em> 中的任意一个即可。</p>
</div>
<div class="sect4">
<h5 id="手动配置拦截服务"><a class="anchor" href="#手动配置拦截服务"></a>手动配置拦截服务</h5>
<div class="paragraph">
<p>在 <em>RegistryServiceImpl</em> 中添加了拦截服务集合。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 拦截集合
 */</span>
<span class="directive">private</span> <span class="predefined-type">List</span>&lt;InterceptService&gt; interceptList;</code></pre>
</div>
</div>
<div class="paragraph">
<p>所以，用户在 <em>spring</em> 配置文件中定义 <em>RegistryService</em> 时，可以直接在注入对应的 <em>InterceptService</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- 定义注册wsdl服务实现 --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">registryService</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.dm.dubbo.wsdl.registry.service.impl.RegistryServiceImpl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">env</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultEnv</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">interceptList</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <img src="./images/icons/callouts/1.png" alt="1">
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>此处注入拦截服务的集合</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="自动加载配置为springbean的拦截服务"><a class="anchor" href="#自动加载配置为springbean的拦截服务"></a>自动加载配置为springBean的拦截服务</h5>
<div class="paragraph">
<p>在 <em>RegistryServiceImpl</em> 中实现了 <em>BeanFactoryPostProcessor</em> 接口， <em>spring</em> 会将 <em>beanFactory</em> 注入进来。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RegistryServiceImpl</span> <span class="directive">implements</span> RegistryService, BeanFactoryPostProcessor{ <img src="./images/icons/callouts/1.png" alt="1">

  <span class="directive">public</span> <span class="type">void</span> postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) <span class="directive">throws</span> BeansException {
    <span class="keyword">if</span> (<span class="local-variable">this</span>.interceptList == <span class="predefined-constant">null</span>) {
        <span class="local-variable">this</span>.interceptList = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;InterceptService&gt;();
    } <img src="./images/icons/callouts/2.png" alt="2">
    <span class="predefined-type">String</span><span class="type">[]</span> beanNames = beanFactory.getBeanNamesForType(InterceptService.class, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>); <img src="./images/icons/callouts/3.png" alt="3">
    <span class="keyword">if</span> (beanNames != <span class="predefined-constant">null</span>) {
        InterceptService interceptService = <span class="predefined-constant">null</span>;
        <span class="keyword">for</span> (<span class="predefined-type">String</span> beanName : beanNames) {
            interceptService = (InterceptService) beanFactory.getBean(beanName);
            <span class="keyword">if</span> (!<span class="local-variable">this</span>.interceptList.contains(interceptService)) {
                <span class="local-variable">this</span>.interceptList.add(interceptService);
            }
        }
    } <img src="./images/icons/callouts/4.png" alt="4">
}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>实现 <em>BeanFactoryPostProcessor</em> 以获取 <em>BeanFactory</em></td>
</tr>
<tr>
<td><img src="./images/icons/callouts/2.png" alt="2"></td>
<td>获取 <em>interceptList</em></td>
</tr>
<tr>
<td><img src="./images/icons/callouts/3.png" alt="3"></td>
<td><code>获得所有实现了 _InterceptService_ 接口的 _spring bean_</code></td>
</tr>
<tr>
<td><img src="./images/icons/callouts/4.png" alt="4"></td>
<td>将实现了 <em>InterceptService</em> 接口的 <em>bean</em> 装载入集合</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>注入拦截服务集合至 <em>client</em> 实现中</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> GenericService genericService = cons.newInstance(wsEnv, <span class="local-variable">this</span>.interceptList); <img src="./images/icons/callouts/1.png" alt="1"></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>通过构造注入 <em>interceptList</em></td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="处理拦截服务集合逻辑"><a class="anchor" href="#处理拦截服务集合逻辑"></a>处理拦截服务集合逻辑</h5>
<div class="paragraph">
<p><em>AbstractGenericService</em> 作为 <em>client</em> 实现的父类，完成了拦截服务的逻辑，同时也将相关方法声明为 <em>protected</em> 方便子类重写。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>将注入的 <em>InterceptService</em> 分类为前置拦截与后置拦截服务</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 初始化InterceptService
 */</span>
<span class="directive">private</span> <span class="type">void</span> initInterceptService() {
  <span class="keyword">if</span> (<span class="local-variable">this</span>.interceptList != <span class="predefined-constant">null</span> &amp;&amp; <span class="local-variable">this</span>.interceptList.size() &gt; <span class="integer">0</span>) {
    <span class="local-variable">this</span>.preList = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;PreProcessService&gt;();
    <span class="local-variable">this</span>.postList = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;PostProcessService&gt;();

    <span class="keyword">for</span> (InterceptService service : <span class="local-variable">this</span>.interceptList) {
      <span class="keyword">if</span> (service <span class="keyword">instanceof</span> PreProcessService) {
        <span class="local-variable">this</span>.preList.add((PreProcessService) service);
      }
      <span class="keyword">if</span> (service <span class="keyword">instanceof</span> PostProcessService) {
        <span class="local-variable">this</span>.postList.add((PostProcessService) service);
      }
    }
  }
}</code></pre>
</div>
</div>
</li>
<li>
<p>处理前置逻辑</p>
<div class="paragraph">
<p>拦截逻辑都是在请求调用的 <em>query</em> 方法中完成的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Object</span> preProcessObj = doPreProcess(methodName, params);
<span class="keyword">if</span> (preProcessObj != <span class="predefined-constant">null</span>)
          <span class="keyword">return</span> preProcessObj;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph">
<p>由上可以看出，前置处理时可以直接返回，不进行请求处理。所以此处可以方便地添加一些 <strong>请求参数校验，用户信息校验</strong> 等。</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>处理后置逻辑</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 调用子类具体查询方法</span>
returnObj = doQuery(methodName, realParams);

<span class="comment">// 处理postProcess</span>
params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">returnObj</span><span class="delimiter">&quot;</span></span>, returnObj);
<span class="predefined-type">Object</span> postProcessObj = doPostProcess(params);
<span class="keyword">if</span> (postProcessObj != <span class="predefined-constant">null</span>)
          <span class="keyword">return</span> postProcessObj; <span class="comment">// 修改返回结果</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph">
<p>同上，后置处理，可以添加一些日志记录功能。也同样可以完成一些返回信息过滤功能，此处可以更改返回结果。</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="em-wsdl-em-文档解析"><a class="anchor" href="#em-wsdl-em-文档解析"></a>14.4. <em>wsdl</em> 文档解析</h3>
<div class="paragraph">
<p>对 <em>wsdl</em> 文档的解析，主要是方便对 <em>webservice</em> 服务的调用，在调用过程中方便指定请求的 <em>arguments</em> 及返回的 <em>returnType</em> 等。</p>
</div>
<div class="sect3">
<h4 id="类图-4"><a class="anchor" href="#类图-4"></a>14.4.1. 类图</h4>
<div class="imageblock">
<div class="content">
<img src="./images/WsdlParse.png" alt="WsdlParse">
</div>
</div>
</div>
<div class="sect3">
<h4 id="实现框架-2"><a class="anchor" href="#实现框架-2"></a>14.4.2. 实现框架</h4>
<div class="paragraph">
<p>同样，与 <em>webservice</em> 调用类似，对 <em>wsdl</em> 的解析也分为了 <em>CXF</em> 与 <em>axis1.4</em> 两种实现。</p>
</div>
<div class="paragraph">
<p>对 <em>CXF</em> 生成的 <em>wsdl</em> 解析，则直接使用的 <em>CXF</em> 客户端来完成的。</p>
</div>
<div class="paragraph">
<p>对 <em>axis1.4</em> 生成的 <em>wsdl</em> 解析，则是使用 <em>wsdl4j</em> <sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</sup> 开源组件完成的。</p>
</div>
<div class="exampleblock">
<div class="title">cxf解析与axis1.4的不同之处</div>
<div class="content">
<div class="paragraph">
<p><em>axis1.4</em> 的解析相对容易，直接使用 <em>wsdl4j</em> 即可完成。</p>
</div>
<div class="paragraph">
<p>而 <em>cxf</em> 则对方法的参数使用了嵌入的 <em>schema</em> 文档来定义的。而 <em>wsdl4j</em> 不支持这种 <em>schema</em> 文档的解析<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnote_5" title="View footnote.">5</a>]</sup>，因为对 <em>schema</em> 的解析需要自己手工完成。</p>
</div>
<div class="paragraph">
<p><em>soapui</em> 中对这两种 <em>wsdl</em> 的解析均有提供，迫于时间关系，未细研究。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="em-cxf-em-的-em-wsdl-em-解析"><a class="anchor" href="#em-cxf-em-的-em-wsdl-em-解析"></a>14.4.3. <em>CXF</em> 的 <em>wsdl</em> 解析</h4>
<div class="paragraph">
<p>对 <em>CXF</em> 生成的 <em>wsdl</em> 的解析，则由实现类 <em>WsdlParseServiceCxfImpl</em> 完成。基本思路都是逐步解析 <em>wsdl</em> 各元素来完成的。</p>
</div>
<div class="listingblock">
<div class="title">code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WsdlParseServiceCxfImpl</span> <span class="directive">extends</span> AbstractWsdlParseService {

        <span class="directive">public</span> WsService parse(<span class="predefined-type">String</span> url) <span class="directive">throws</span> <span class="exception">Exception</span> {
                WsService wsService = <span class="keyword">new</span> WsService();

                <span class="comment">// 创建动态客户端</span>
                JaxWsDynamicClientFactory factory = JaxWsDynamicClientFactory.newInstance();
                <span class="comment">// 创建客户端连接</span>
                Client client = factory.createClient(url);
                ClientImpl clientImpl = (ClientImpl) client;
                Endpoint endpoint = clientImpl.getEndpoint();

                wsService.setWsdlUrl(url);
                wsService.setServiceName(endpoint.getService().getName().getLocalPart());
                wsService.setTargetNameSpace(endpoint.getService().getName().getNamespaceURI());

                BindingInfo bindingInfo = endpoint.getBinding().getBindingInfo();
                <span class="predefined-type">Collection</span>&lt;BindingOperationInfo&gt; opInfoCol = bindingInfo.getOperations();
                <span class="predefined-type">Iterator</span>&lt;BindingOperationInfo&gt; it = opInfoCol.iterator();

                <span class="comment">// 遍历方法</span>
                <span class="predefined-type">List</span>&lt;WsOperation&gt; opList = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;WsOperation&gt;();
                WsOperation wsOperation = <span class="predefined-constant">null</span>;
                <span class="keyword">while</span> (it.hasNext()) {
                        wsOperation = <span class="keyword">new</span> WsOperation();

                        BindingOperationInfo boi = it.next();
                        <span class="predefined-type">String</span> opName = boi.getName().getLocalPart();
                        wsOperation.setName(opName); <span class="comment">// 设置方法名</span>

                        <span class="comment">// 通过输入消息找到对应的请求参数列表</span>
                        BindingMessageInfo inputMsgInfo = boi.getInput();
                        <span class="predefined-type">List</span>&lt;MessagePartInfo&gt; parts = inputMsgInfo.getMessageParts();

                        <span class="predefined-type">List</span>&lt;WsArgument&gt; args = <span class="keyword">new</span> <span class="predefined-type">LinkedList</span>&lt;WsArgument&gt;();
                        WsArgument wsArg = <span class="predefined-constant">null</span>;
                        <span class="keyword">for</span> (MessagePartInfo part : parts) {
                                <span class="predefined-type">Field</span><span class="type">[]</span> fields = part.getTypeClass().getDeclaredFields();
                                <span class="keyword">for</span> (<span class="predefined-type">Field</span> field : fields) {
                                        <span class="predefined-type">Type</span> type = field.getGenericType();
                                        <span class="predefined-type">String</span> typeStr = type.toString();
                                        <span class="keyword">if</span> (typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;</span><span class="delimiter">&quot;</span></span>) != -<span class="integer">1</span> &amp;&amp; typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>) != -<span class="integer">1</span>) {
                                                typeStr = typeStr.substring(typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;</span><span class="delimiter">&quot;</span></span>) + <span class="integer">1</span>, typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>));
                                        }

                                        <span class="comment">// 设置入参</span>
                                        <span class="comment">// TODO 目前只支持简单类型的入参，复杂类型需要递归处理</span>
                                        wsArg = <span class="keyword">new</span> WsArgument();
                                        wsArg.setName(field.getName());
                                        wsArg.setType(typeStr);
                                        args.add(wsArg);
                                }
                        }

                        <span class="comment">// 通过输出消息拿到返回类型</span>
                        BindingMessageInfo outputMsgInfo = boi.getInput();
                        parts = outputMsgInfo.getMessageParts();

                        <span class="keyword">for</span> (MessagePartInfo part : parts) {
                                <span class="predefined-type">Field</span><span class="type">[]</span> fields = part.getTypeClass().getDeclaredFields();
                                <span class="keyword">for</span> (<span class="predefined-type">Field</span> field : fields) {
                                        <span class="predefined-type">Type</span> type = field.getGenericType();
                                        <span class="predefined-type">String</span> typeStr = type.toString();
                                        <span class="keyword">if</span> (typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;</span><span class="delimiter">&quot;</span></span>) != -<span class="integer">1</span> &amp;&amp; typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>) != -<span class="integer">1</span>) {
                                                typeStr = typeStr.substring(typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;</span><span class="delimiter">&quot;</span></span>) + <span class="integer">1</span>, typeStr.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>));
                                        }
                                        wsOperation.setReturnType(typeStr);
                                        <span class="keyword">break</span>;
                                }
                        }

                        wsOperation.setInputArgs(args);
                        opList.add(wsOperation);
                }
                wsService.setOpList(opList);
                <span class="keyword">return</span> wsService;
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="em-axis1-4-em-的-em-wsdl-em-解析"><a class="anchor" href="#em-axis1-4-em-的-em-wsdl-em-解析"></a>14.4.4. <em>axis1.4</em> 的 <em>wsdl</em> 解析</h4>
<div class="paragraph">
<p><em>axis1.4</em> 的 <em>wsdl</em> 解析，则是由 <em>wsdl4j</em> 完成。思路同上，直接读取 <em>wsdl</em> 文件，逐一解析各元素即可。</p>
</div>
<div class="listingblock">
<div class="title">code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.dm.dubbo.wsdl.registry.util</span>;

<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.Iterator</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="keyword">import</span> <span class="include">javax.wsdl.Binding</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Definition</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Input</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Message</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Operation</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Output</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Part</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Port</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.PortType</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.Service</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.WSDLException</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.factory.WSDLFactory</span>;
<span class="keyword">import</span> <span class="include">javax.wsdl.xml.WSDLReader</span>;
<span class="keyword">import</span> <span class="include">javax.xml.namespace.QName</span>;

<span class="keyword">import</span> <span class="include">org.apache.log4j.Logger</span>;
<span class="keyword">import</span> <span class="include">org.springframework.util.Assert</span>;

<span class="keyword">import</span> <span class="include">com.dm.dubbo.wsdl.registry.domain.WsArgument</span>;
<span class="keyword">import</span> <span class="include">com.dm.dubbo.wsdl.registry.domain.WsOperation</span>;
<span class="keyword">import</span> <span class="include">com.dm.dubbo.wsdl.registry.domain.WsService</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">WsdlParseUtil</span> {

        <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Logger</span> logger = <span class="predefined-type">Logger</span>.getLogger(WsdlParseUtil.class);
        <span class="directive">private</span> <span class="directive">static</span> WSDLFactory factory;
        <span class="directive">private</span> <span class="directive">static</span> WSDLReader reader;

        <span class="directive">static</span> {
                <span class="keyword">try</span> {
                        factory = WSDLFactory.newInstance();
                        reader = factory.newWSDLReader();

                        reader.setFeature(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.wsdl.verbose</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
                        reader.setFeature(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.wsdl.importDocuments</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
                } <span class="keyword">catch</span> (WSDLException e) {
                        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">init wsdl factory error!</span><span class="delimiter">&quot;</span></span>, e);
                }
        }

        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">public</span> <span class="directive">static</span> WsService parse(<span class="predefined-type">String</span> url) {
                Assert.notNull(url, <span class="string"><span class="delimiter">&quot;</span><span class="content">wsdl url can't be null or empty!</span><span class="delimiter">&quot;</span></span>);

                <span class="keyword">try</span> {
                        <span class="comment">// 解析wsdl</span>
                        Definition def = reader.readWSDL(url);

                        <span class="comment">// 设置命名空间</span>
                        WsService wsService = <span class="keyword">new</span> WsService();
                        wsService.setWsdlUrl(url);
                        wsService.setTargetNameSpace(def.getTargetNamespace());

                        <span class="comment">// 获取服务</span>
                        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">QName</span>, Service&gt; map = def.getServices();
                        <span class="keyword">if</span> (map == <span class="predefined-constant">null</span> || map.size() &lt;= <span class="integer">0</span>) {
                                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">no service found on wsdl:</span><span class="delimiter">&quot;</span></span> + url);
                                <span class="keyword">return</span> <span class="predefined-constant">null</span>;
                        }

                        Service service = <span class="predefined-constant">null</span>;
                        <span class="predefined-type">Iterator</span>&lt;Service&gt; it = map.values().iterator();
                        <span class="keyword">while</span> (it.hasNext()) {
                                service = it.next();
                                <span class="keyword">break</span>; <span class="comment">// 只取第一个服务</span>
                        }

                        <span class="keyword">if</span> (service != <span class="predefined-constant">null</span>) {
                                wsService.setServiceName(service.getQName().getLocalPart());

                                <span class="comment">// 获取Ports</span>
                                <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Port</span>&gt; ports = service.getPorts();
                                <span class="keyword">if</span> (ports != <span class="predefined-constant">null</span> &amp;&amp; ports.size() &gt; <span class="integer">0</span>) {

                                        <span class="predefined-type">Port</span> port = <span class="predefined-constant">null</span>;
                                        <span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">Port</span>&gt; portIt = ports.values().iterator();
                                        <span class="keyword">while</span> (portIt.hasNext()) {
                                                port = portIt.next();
                                                <span class="keyword">break</span>;
                                        }

                                        <span class="comment">// 获取所有方法</span>
                                        <span class="keyword">if</span> (port != <span class="predefined-constant">null</span>) {
                                                <span class="predefined-type">Binding</span> binding = port.getBinding();
                                                PortType portType = binding.getPortType();
                                                <span class="predefined-type">List</span>&lt;<span class="predefined-type">Operation</span>&gt; operations = portType.getOperations();

                                                <span class="keyword">if</span> (operations == <span class="predefined-constant">null</span> || operations.size() &lt;= <span class="integer">0</span>) {
                                                        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">no operation found on this wsdl :</span><span class="delimiter">&quot;</span></span> + url);
                                                } <span class="keyword">else</span> {
                                                        WsOperation wsOp = <span class="predefined-constant">null</span>;
                                                        <span class="predefined-type">List</span>&lt;WsOperation&gt; opList = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;WsOperation&gt;();
                                                        <span class="keyword">for</span> (<span class="predefined-type">Operation</span> op : operations) {
                                                                <span class="keyword">if</span> (!op.isUndefined()) {
                                                                        <span class="comment">// 获取输入参数与返回类型</span>
                                                                        <span class="predefined-type">List</span>&lt;WsArgument&gt; args = WsdlParseUtil.getInputParameters(op);
                                                                        <span class="predefined-type">String</span> returnType = WsdlParseUtil.getReturnType(op);

                                                                        <span class="comment">// 组装为WsOperation</span>
                                                                        wsOp = <span class="keyword">new</span> WsOperation(op.getName(), args, returnType);
                                                                        opList.add(wsOp);
                                                                }
                                                        }
                                                        wsService.setOpList(opList);
                                                }
                                        }
                                }

                                <span class="keyword">return</span> wsService;
                        }
                } <span class="keyword">catch</span> (WSDLException e) {
                        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">parse wsdl error! url:</span><span class="delimiter">&quot;</span></span> + url, e);
                }
                <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }

        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> getReturnType(<span class="predefined-type">Operation</span> op) {
                Output output = op.getOutput();
                Message msgOut = output.getMessage();

                <span class="keyword">if</span> (!msgOut.isUndefined()) {
                        <span class="predefined-type">Iterator</span>&lt;Part&gt; partIter = msgOut.getParts().values().iterator();

                        <span class="keyword">while</span> (partIter.hasNext()) {
                                Part part = partIter.next();
                                <span class="keyword">if</span> (part.getTypeName() != <span class="predefined-constant">null</span>) {
                                        <span class="keyword">return</span> part.getTypeName().getLocalPart(); <span class="comment">// 获取返回类型</span>
                                }
                        }
                }
                <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }

        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">List</span>&lt;WsArgument&gt; getInputParameters(<span class="predefined-type">Operation</span> op) {
                <span class="predefined-type">List</span>&lt;WsArgument&gt; list = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;WsArgument&gt;();

                WsArgument arg = <span class="predefined-constant">null</span>;
                Input input = op.getInput();
                Message msg = input.getMessage();

                <span class="comment">// 构造请求参数</span>
                <span class="keyword">if</span> (!msg.isUndefined()) {
                        <span class="predefined-type">Iterator</span>&lt;Part&gt; partIter = msg.getParts().values().iterator();
                        <span class="keyword">while</span> (partIter.hasNext()) {
                                Part part = partIter.next();
                                arg = <span class="keyword">new</span> WsArgument();
                                arg.setName(part.getName());
                                <span class="keyword">if</span> (part.getTypeName() != <span class="predefined-constant">null</span>) {
                                        arg.setType(part.getTypeName().getLocalPart());
                                }
                                list.add(arg);
                        }
                }
                <span class="keyword">return</span> list;
        }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="启动与打包"><a class="anchor" href="#启动与打包"></a>15. 启动与打包</h2>
<div class="sectionbody">
<div class="paragraph">
<p>由于 <em>wsdl</em> 非 <em>web</em> 工程，所以只需要直接使用 <em>java</em> 命令启动包含 <em>main</em> 方法的类即可。</p>
</div>
<div class="sect2">
<h3 id="启动方式"><a class="anchor" href="#启动方式"></a>15.1. 启动方式</h3>
<div class="sect3">
<h4 id="编写main方法启动"><a class="anchor" href="#编写main方法启动"></a>15.1.1. 编写main方法启动</h4>
<div class="paragraph">
<p>整个 <em>wsdl</em> 工程中的服务的发布与注册均是通过配置文件完成的。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/wsdl_resource.png" alt="wsdl resource">
</div>
<div class="title">spring配置文件</div>
</div>
<div class="paragraph">
<p>所以从 <em>main</em> 方法启动则直接加载这些 <em>spring</em> 配置文件即可。</p>
</div>
<div class="exampleblock">
<div class="title">示例</div>
<div class="content">
<div class="paragraph">
<p>使用 <em>ClassPathXmlApplicationContext</em> 加载 <em>Spring</em> 配置文件。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ClassPathXmlApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:beans-*.xml</span><span class="delimiter">&quot;</span></span>);
applicationContext.start();

<span class="predefined-type">System</span>.in.read(); <img src="./images/icons/callouts/1.png" alt="1"></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>阻止主线程自动运行关闭</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="以-em-dubbo-em-提供的-em-main-em-类启动"><a class="anchor" href="#以-em-dubbo-em-提供的-em-main-em-类启动"></a>15.1.2. 以 <em>dubbo</em> 提供的 <em>Main</em> 类启动</h4>
<div class="paragraph">
<p>其实在 <em>dubbo</em> 的官网上既不推荐以 <em>tomcat</em> 容器方式启动，也不推荐上面的 <em>main</em> 方法启动，而是推荐 <em>dubbo</em> 自己提供的 <em>Main</em> 类启动的，因为它支持 <strong>优雅停机</strong> 。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/wsdl_main.png" alt="wsdl main">
</div>
<div class="title">idea下配置示例</div>
</div>
<div class="ulist">
<ul>
<li>
<p>在 <em>ide</em> 下则配置以 <em>com.alibaba.dubbo.container.Main</em> 启动运行即可。</p>
</li>
<li>
<p>生产环境下，则应该以 <code>java com.alibaba.dubbo.container.Main</code> 方式启动。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="打包"><a class="anchor" href="#打包"></a>15.2. 打包</h3>
<div class="paragraph">
<p>如果直接将 <em>dmga-dubbo-wsdl</em> 工程打成一个 <em>jar</em> 包扔到生产环境下去跑的话，那么它的依赖 <em>jar</em> 呢？
所以在打包的同时，也需要同时将它的依赖 <em>jar</em> 也一起打包。</p>
</div>
<div class="paragraph">
<p>此时需要配置 <strong><em>pom.xml</em></strong> 中的 <em>maven-jar-plugin</em> 以及 <em>maven-assembly-plugin</em> . 配置步骤如下。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">maven-jar-plugin</dt>
<dd>
<p>在 <strong><em>pom.xml</em></strong> 中添加 <em>maven-jar-plugin</em> 的配置，注意放在 <code>&lt;bulid&gt;&lt;plugins&gt;&lt;/plugins&gt;&lt;/build&gt;</code> 中。</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-jar-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.4<span class="tag">&lt;/version&gt;</span>
    <span class="comment">&lt;!-- The configuration of the plugin --&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="comment">&lt;!-- 排队根目录下的配置文件，因为配置文件会使用assembly插件打包到conf目录 --&gt;</span>
        <span class="tag">&lt;excludes&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>*.xml<span class="tag">&lt;/exclude&gt;</span>
            <span class="tag">&lt;exclude&gt;</span>*.properties<span class="tag">&lt;/exclude&gt;</span>
        <span class="tag">&lt;/excludes&gt;</span>
        <span class="comment">&lt;!-- Configuration of the archiver --&gt;</span>
        <span class="tag">&lt;archive&gt;</span>

            <span class="comment">&lt;!--
                生成的jar中，不要包含pom.xml和pom.properties这两个文件
            --&gt;</span>
            <span class="tag">&lt;addMavenDescriptor&gt;</span>false<span class="tag">&lt;/addMavenDescriptor&gt;</span>

            <span class="comment">&lt;!-- Manifest specific configuration --&gt;</span>
            <span class="tag">&lt;manifest&gt;</span>

                <span class="comment">&lt;!--
                    是否要把第三方jar放到manifest的classpath中
                --&gt;</span>
                <span class="comment">&lt;!--&lt;addClasspath&gt;true&lt;/addClasspath&gt;--&gt;</span>
                <span class="comment">&lt;!--
                   生成的manifest中classpath的前缀，因为要把第三方jar放到lib目录下，所以classpath的前缀是lib/
               --&gt;</span>
                <span class="tag">&lt;classpathPrefix&gt;</span>lib/<span class="tag">&lt;/classpathPrefix&gt;</span>
                <span class="comment">&lt;!--&lt;mainClass&gt;com.alibaba.dubbo.container.Main&lt;/mainClass&gt;--&gt;</span>
                <span class="comment">&lt;!--
                    应用的main class
                --&gt;</span>
            <span class="tag">&lt;/manifest&gt;</span>
        <span class="tag">&lt;/archive&gt;</span>
        <span class="comment">&lt;!--
            过滤掉不希望包含在jar中的文件
        --&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">maven-assembly-plugin</dt>
<dd>
<p>该插件加载具体的打包配置</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- The configuration of maven-assembly-plugin --&gt;</span>
<span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-assembly-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.4<span class="tag">&lt;/version&gt;</span>
    <span class="comment">&lt;!-- The configuration of the plugin --&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="comment">&lt;!-- Specifies the configuration file of the assembly plugin --&gt;</span>
        <span class="tag">&lt;descriptors&gt;</span>
            <span class="tag">&lt;descriptor&gt;</span>${project.basedir}/src/main/resources/package.xml<span class="tag">&lt;/descriptor&gt;</span> <img src="./images/icons/callouts/1.png" alt="1">
        <span class="tag">&lt;/descriptors&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;id&gt;</span>make-assembly<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;phase&gt;</span>package<span class="tag">&lt;/phase&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>single<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="./images/icons/callouts/1.png" alt="1"></td>
<td>指定了package.xml的路径</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">package.xml </dt>
<dd>
<p>package.xml中配置了具体的打包细节。</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;assembly&gt;</span>
    <span class="tag">&lt;id&gt;</span>bin<span class="tag">&lt;/id&gt;</span>
    <span class="comment">&lt;!-- 最终打包成一个用于发布的zip文件 --&gt;</span>
    <span class="tag">&lt;formats&gt;</span>
        <span class="tag">&lt;format&gt;</span>zip<span class="tag">&lt;/format&gt;</span>
    <span class="tag">&lt;/formats&gt;</span>

    <span class="comment">&lt;!-- Adds dependencies to zip package under lib directory --&gt;</span>
    <span class="tag">&lt;dependencySets&gt;</span>
        <span class="tag">&lt;dependencySet&gt;</span>
            <span class="comment">&lt;!--
               不使用项目的artifact，第三方jar不要解压，打包进zip文件的lib目录
           --&gt;</span>
            <span class="tag">&lt;useProjectArtifact&gt;</span>false<span class="tag">&lt;/useProjectArtifact&gt;</span>
            <span class="tag">&lt;outputDirectory&gt;</span>lib<span class="tag">&lt;/outputDirectory&gt;</span>
            <span class="tag">&lt;unpack&gt;</span>false<span class="tag">&lt;/unpack&gt;</span>
        <span class="tag">&lt;/dependencySet&gt;</span>
    <span class="tag">&lt;/dependencySets&gt;</span>

    <span class="tag">&lt;fileSets&gt;</span>
        <span class="comment">&lt;!-- 把项目相关的说明文件，打包进zip文件的根目录 --&gt;</span>
        <span class="tag">&lt;fileSet&gt;</span>
            <span class="tag">&lt;directory&gt;</span>${project.basedir}<span class="tag">&lt;/directory&gt;</span>
            <span class="tag">&lt;outputDirectory&gt;</span>/<span class="tag">&lt;/outputDirectory&gt;</span>
            <span class="tag">&lt;includes&gt;</span>
                <span class="tag">&lt;include&gt;</span>README*<span class="tag">&lt;/include&gt;</span>
                <span class="tag">&lt;include&gt;</span>LICENSE*<span class="tag">&lt;/include&gt;</span>
                <span class="tag">&lt;include&gt;</span>NOTICE*<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;/includes&gt;</span>
        <span class="tag">&lt;/fileSet&gt;</span>

        <span class="comment">&lt;!-- 把项目的配置文件，打包进zip文件的config目录 --&gt;</span>
        <span class="tag">&lt;fileSet&gt;</span>
            <span class="tag">&lt;directory&gt;</span>${project.build.directory}/classes<span class="tag">&lt;/directory&gt;</span>
            <span class="tag">&lt;outputDirectory&gt;</span>conf<span class="tag">&lt;/outputDirectory&gt;</span>
            <span class="tag">&lt;includes&gt;</span>
                <span class="tag">&lt;include&gt;</span>*.xml<span class="tag">&lt;/include&gt;</span>
                <span class="tag">&lt;include&gt;</span>*.properties<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;/includes&gt;</span>
        <span class="tag">&lt;/fileSet&gt;</span>

        <span class="comment">&lt;!-- 把项目的脚本文件目录（ src/main/scripts ）中的启动脚本文件，打包进zip文件的bin目录 --&gt;</span>
        <span class="tag">&lt;fileSet&gt;</span>
            <span class="tag">&lt;directory&gt;</span>${project.build.scriptSourceDirectory}<span class="tag">&lt;/directory&gt;</span>
            <span class="tag">&lt;outputDirectory&gt;</span>bin<span class="tag">&lt;/outputDirectory&gt;</span>
            <span class="comment">&lt;!--
            &lt;includes&gt;
                &lt;include&gt;startup.*&lt;/include&gt;
            &lt;/includes&gt;
            --&gt;</span>
        <span class="tag">&lt;/fileSet&gt;</span>

        <span class="comment">&lt;!-- 把项目的脚本文件（除了启动脚本文件），打包进zip文件的script目录 --&gt;</span>
        <span class="comment">&lt;!--
        &lt;fileSet&gt;
            &lt;directory&gt;${project.build.scriptSourceDirectory}&lt;/directory&gt;
            &lt;outputDirectory&gt;&lt;/outputDirectory&gt;
            &lt;includes&gt;
                &lt;exclude&gt;startup.*&lt;/exclude&gt;
            &lt;/includes&gt;
        &lt;/fileSet&gt;
        --&gt;</span>

        <span class="comment">&lt;!-- 把项目自己编译出来的jar文件，打包进zip文件的lib目录 --&gt;</span>
        <span class="tag">&lt;fileSet&gt;</span>
            <span class="tag">&lt;directory&gt;</span>${project.build.directory}<span class="tag">&lt;/directory&gt;</span>
            <span class="tag">&lt;outputDirectory&gt;</span>lib<span class="tag">&lt;/outputDirectory&gt;</span>
            <span class="tag">&lt;includes&gt;</span>
                <span class="tag">&lt;include&gt;</span>*.jar<span class="tag">&lt;/include&gt;</span>
            <span class="tag">&lt;/includes&gt;</span>
        <span class="tag">&lt;/fileSet&gt;</span>
    <span class="tag">&lt;/fileSets&gt;</span>
<span class="tag">&lt;/assembly&gt;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>按上述配置文件配置完毕后，使用 <em>maven</em> 执行命令 <code>mvn clean package -Dmaven.test.skip=true</code> 将会在 <em>target</em> 目录下产生出 *-bin.zip 文件。该 <em>zip</em> 包解压后即是一个可运行包。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/wsdl_bin.png" alt="wsdl bin">
</div>
</div>
</div>
<div class="sect2">
<h3 id="启动脚本"><a class="anchor" href="#启动脚本"></a>15.3. 启动脚本</h3>
<div class="paragraph">
<p>为了简化生产环境下的一些启动与停止服务操作，则特地将一些命令整成启动脚本存放。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/wsdl_scripts.png" alt="wsdl scripts">
</div>
</div>
<div class="paragraph">
<p>在上述的打包命令中，则是直接将这些启动 <em>scripts</em> 打包到了 <em>bin</em> 目录。</p>
</div>
<div class="paragraph">
<p>具体内容可直接查看脚本内容。</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. 指用户信息不一致，角色权限不一致的情况
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. 方便集成其它系统
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. <em>soapui</em> 是一个开源的 <em>webservice</em> 调用工具
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. <em>wsdl4j</em> 是一个开源的 <em>wsdl</em> 文档解析组件，不过现在快被 <em>out</em> 了。
</div>
<div class="footnote" id="_footnote_5">
<a href="#_footnoteref_5">5</a>. 其官网资料上也明确指出， <em>wsdl4j</em> 不支持这种 <em>schema</em> 的解析，只支持将其简单地转换为 <em>w3c dom</em>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2016-03-26 22:10:44 中国标准时间
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>